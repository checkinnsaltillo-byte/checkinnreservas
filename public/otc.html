<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-In ¬∑ Reservas & Ocupaci√≥n (Lodgify)</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#0b1020;
      --muted:#667085;
      --border:#e5e7eb;
      --chip:#f3f4f6;
      --chipfg:#111827;
      --shadow: 0 14px 40px rgba(2,6,23,.12);
      --radius:14px;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;max-width:1180px;color:var(--fg);background:var(--bg)}
    h1{margin:0 0 8px 0;font-size:22px}
    h2{margin:22px 0 10px 0;font-size:18px}
    .muted{color:var(--muted);font-size:13px;line-height:1.4}
    .card{border:1px solid var(--border);border-radius:var(--radius);padding:14px 14px 12px 14px;box-shadow:0 1px 0 rgba(2,6,23,.03)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:end}
    label{display:flex;flex-direction:column;font-size:13px;gap:6px;min-width:160px}
    input,select,button{font-size:14px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    button{cursor:pointer}
    button.primary{background:#0b5fff;border-color:#0b5fff;color:#fff}
    button:disabled{opacity:.55;cursor:not-allowed}
    pre{background:#0b1020;color:#d7e2ff;padding:14px;border-radius:14px;overflow:auto;max-height:340px}
    .split{display:grid;grid-template-columns: 1fr;gap:14px}
    @media (min-width: 980px){.split{grid-template-columns: 1fr 1fr}}

    /* ---------- Table ---------- */
    .tableWrap{border:1px solid var(--border);border-radius:var(--radius);overflow:auto;max-height:540px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:860px;background:#fff}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap;font-size:13px}
    th{position:sticky;top:0;background:#fafafa;z-index:2;text-align:left}
    td.num{text-align:right;font-variant-numeric: tabular-nums}
    tr:hover td{background:#fcfcff}
    .tag{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--chipfg);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}

    /* ---------- MultiSelect (no se recorta por contenedores) ---------- */
    .ms{position:relative}
    .msBtn{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .msBtn .msLabel{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .msBtn .msPlaceholder{color:var(--muted)}
    .msCaret{opacity:.7}

    /* Panel se monta en <body> con position:fixed */
    .msPanel{
      position:fixed;
      min-width:260px;
      max-width:min(520px, calc(100vw - 24px));
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      z-index:99999;
      padding:10px;
    }
    .msPanel header{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .msPanel input[type="search"]{flex:1;min-width:160px}
    .msList{max-height:260px;overflow:auto;border-top:1px solid var(--border);padding-top:8px}
    .msItem{display:flex;gap:10px;align-items:center;padding:8px 8px;border-radius:10px;cursor:pointer}
    .msItem:hover{background:#f8fafc}
    .msItem input{width:16px;height:16px}
    .msFoot{display:flex;justify-content:space-between;gap:8px;margin-top:10px}
    .msFoot button{padding:8px 10px;border-radius:10px}

    .hint{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
  </style>
</head>
<body>
  <h1>Reservas & Ocupaci√≥n (Lodgify)</h1>
  <p class="muted">
    Este panel usa tu backend en Cloud Run (mismo dominio) y resuelve el problema de dropdown recortado
    montando los men√∫s en <code>position:fixed</code> sobre <code>&lt;body&gt;</code>.
  </p>

  <div class="split">
    <div class="card">
      <h2>Par√°metros</h2>
      <div class="row">
        <label>
          Desde
          <input id="from" type="date" value="2026-01-01">
        </label>
        <label>
          Hasta
          <input id="to" type="date" value="2026-01-31">
        </label>
        <label>
          L√≠mite por p√°gina
          <input id="limit" type="number" value="200" min="10" max="200">
        </label>
        <label>
          fetchMode
          <select id="fetchMode">
            <option value="all" selected>all (recomendado)</option>
            <option value="filtered">filtered (prueba)</option>
          </select>
        </label>

        <label style="min-width:260px">
          Propiedad
          <div id="propiedadMs" class="ms"></div>
        </label>

        <label style="min-width:320px">
          Meses para promedio (X)
          <div id="mesesAvgMs" class="ms"></div>
        </label>

        <button id="btnLoad" class="primary">Cargar</button>
        <button id="btnCsv">Descargar CSV (OTC)</button>
        <button id="btnDebug">Debug Lodgify</button>
      </div>

      <div class="hint">
        <span class="tag">üìå Promedio: si no eliges meses, se promedia sobre todos los meses visibles.</span>
        <span class="tag">üßæ CSV: usa el endpoint OTC original (prorrateado por noches).</span>
      </div>
    </div>

    <div class="card">
      <h2>Salida</h2>
      <pre id="out">Listo.</pre>
    </div>
  </div>

  <h2>Ocupaci√≥n por alojamiento (por mes)</h2>
  <p class="muted">Ocupaci√≥n = noches ocupadas / noches del mes. La √∫ltima columna muestra el promedio de los meses seleccionados (X).</p>
  <div class="tableWrap">
    <table id="tblOcc">
      <thead id="tblOccHead"></thead>
      <tbody id="tblOccBody"></tbody>
    </table>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const out = (x) => ($("out").textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2));

    function qsBase() {
      const from = $("from").value;
      const to = $("to").value;
      const limit = $("limit").value;
      const fetchMode = $("fetchMode").value;
      return new URLSearchParams({ from, to, limit, fetchMode }).toString();
    }

    // ---------------- MultiSelect (portal a body) ----------------
    function createMultiSelect({ mountEl, placeholder = "Selecciona...", items = [], onChange }) {
      const state = {
        items: [],
        selected: new Set(),
        panel: null,
        search: "",
      };

      function setItems(newItems) {
        state.items = [...newItems];
        // conserva selecci√≥n s√≥lo si existe
        const allowed = new Set(state.items.map((x) => x.value));
        state.selected = new Set([...state.selected].filter((v) => allowed.has(v)));
        renderBtn();
        renderPanel();
      }

      function setSelected(values) {
        state.selected = new Set(values);
        renderBtn();
        if (typeof onChange === "function") onChange(getSelected());
      }

      function getSelected() {
        return [...state.selected];
      }

      function closePanel() {
        if (state.panel) {
          state.panel.remove();
          state.panel = null;
          document.removeEventListener("mousedown", onDocDown, true);
          window.removeEventListener("scroll", closePanel, true);
          window.removeEventListener("resize", closePanel, true);
        }
      }

      function onDocDown(e) {
        if (!state.panel) return;
        if (state.panel.contains(e.target)) return;
        if (mountEl.contains(e.target)) return;
        closePanel();
      }

      function renderBtn() {
        mountEl.innerHTML = "";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "msBtn";
        btn.innerHTML = `
          <div class="msLabel">
            <span class="${state.selected.size ? "" : "msPlaceholder"}">
              ${state.selected.size ? "" : placeholder}
            </span>
          </div>
          <span class="msCaret">‚ñæ</span>
        `;

        const labelWrap = btn.querySelector(".msLabel");
        if (state.selected.size) {
          const selectedItems = state.items.filter((x) => state.selected.has(x.value));
          const max = 3;
          selectedItems.slice(0, max).forEach((it) => {
            const chip = document.createElement("span");
            chip.className = "tag";
            chip.textContent = it.label;
            labelWrap.appendChild(chip);
          });
          if (selectedItems.length > max) {
            const more = document.createElement("span");
            more.className = "tag";
            more.textContent = `+${selectedItems.length - max}`;
            labelWrap.appendChild(more);
          }
        }

        btn.addEventListener("click", () => {
          if (state.panel) return closePanel();
          openPanel(btn);
        });

        mountEl.appendChild(btn);
      }

      function openPanel(btn) {
        const r = btn.getBoundingClientRect();
        const panel = document.createElement("div");
        panel.className = "msPanel";
        panel.style.left = `${Math.max(12, Math.min(r.left, window.innerWidth - 12))}px`;
        panel.style.top = `${Math.min(r.bottom + 8, window.innerHeight - 12)}px`;

        panel.innerHTML = `
          <header>
            <input type="search" placeholder="Buscar..." />
            <span class="tag">${state.selected.size} seleccionados</span>
          </header>
          <div class="msList"></div>
          <div class="msFoot">
            <button type="button" data-act="all">Seleccionar todo</button>
            <button type="button" data-act="none">Limpiar</button>
          </div>
        `;

        document.body.appendChild(panel);
        state.panel = panel;

        const search = panel.querySelector('input[type="search"]');
        const list = panel.querySelector(".msList");

        function renderList() {
          const q = (state.search || "").trim().toLowerCase();
          const filtered = !q
            ? state.items
            : state.items.filter((x) => x.label.toLowerCase().includes(q));

          list.innerHTML = "";
          for (const it of filtered) {
            const row = document.createElement("div");
            row.className = "msItem";
            row.innerHTML = `
              <input type="checkbox" ${state.selected.has(it.value) ? "checked" : ""} />
              <div style="display:flex;flex-direction:column;gap:2px">
                <div style="font-weight:600">${it.label}</div>
                <div class="muted" style="font-size:12px">${it.value}</div>
              </div>
            `;
            row.addEventListener("click", (e) => {
              if (e.target && e.target.tagName === "INPUT") return;
              const v = it.value;
              if (state.selected.has(v)) state.selected.delete(v);
              else state.selected.add(v);
              renderList();
              renderHeaderCount();
              renderBtn();
              if (typeof onChange === "function") onChange(getSelected());
            });

            const cb = row.querySelector("input");
            cb.addEventListener("change", () => {
              const v = it.value;
              if (cb.checked) state.selected.add(v);
              else state.selected.delete(v);
              renderHeaderCount();
              renderBtn();
              if (typeof onChange === "function") onChange(getSelected());
            });

            list.appendChild(row);
          }
        }

        function renderHeaderCount() {
          const badge = panel.querySelector("header .tag");
          if (badge) badge.textContent = `${state.selected.size} seleccionados`;
        }

        search.addEventListener("input", () => {
          state.search = search.value || "";
          renderList();
        });

        panel.querySelector('[data-act="all"]').addEventListener("click", () => {
          for (const it of state.items) state.selected.add(it.value);
          renderList();
          renderHeaderCount();
          renderBtn();
          if (typeof onChange === "function") onChange(getSelected());
        });

        panel.querySelector('[data-act="none"]').addEventListener("click", () => {
          state.selected.clear();
          renderList();
          renderHeaderCount();
          renderBtn();
          if (typeof onChange === "function") onChange(getSelected());
        });

        renderList();

        // cerrar al click fuera / scroll / resize
        setTimeout(() => {
          document.addEventListener("mousedown", onDocDown, true);
          window.addEventListener("scroll", closePanel, true);
          window.addEventListener("resize", closePanel, true);
        }, 0);
      }

      function renderPanel() {
        // si est√° abierto, re-render list
        if (!state.panel) return;
        const search = state.panel.querySelector('input[type="search"]');
        state.search = search ? (search.value || "") : "";
        const list = state.panel.querySelector(".msList");
        if (!list) return;
        // dispara re-render por cierre y reapertura simple:
        const btn = mountEl.querySelector("button.msBtn");
        closePanel();
        if (btn) openPanel(btn);
      }

      // init
      setItems(items);
      renderBtn();

      return { setItems, setSelected, getSelected };
    }

    // ---------------- Ocupaci√≥n helpers ----------------
    const fmtMes = new Intl.DateTimeFormat("es-MX", { month: "short", year: "numeric" });

    function toMonthKeyUTC(d) {
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    function parseISO(iso) {
      // UTC midnight
      return new Date(`${iso}T00:00:00Z`);
    }

    function daysInMonthUTC(year, month1to12) {
      // month1to12: 1..12
      return new Date(Date.UTC(year, month1to12, 0)).getUTCDate();
    }

    function monthRange(fromISO, toISO) {
      const from = parseISO(fromISO);
      const to = parseISO(toISO);
      const cur = new Date(Date.UTC(from.getUTCFullYear(), from.getUTCMonth(), 1));
      const end = new Date(Date.UTC(to.getUTCFullYear(), to.getUTCMonth(), 1));
      const out = [];
      while (cur <= end) {
        const key = toMonthKeyUTC(cur);
        const label = fmtMes.format(cur).replace(".", ""); // ej. "ene 2026"
        out.push({ value: key, label });
        cur.setUTCMonth(cur.getUTCMonth() + 1);
      }
      return out;
    }

    function clampToRange(arrivalISO, departureISO, fromISO, toISO) {
      const a = parseISO(arrivalISO);
      const d = parseISO(departureISO);
      const from = parseISO(fromISO);
      const toExclusive = parseISO(toISO);
      toExclusive.setUTCDate(toExclusive.getUTCDate() + 1);

      const start = a > from ? a : from;
      const end = d < toExclusive ? d : toExclusive;
      if (end <= start) return null;
      return { start, end }; // end es exclusivo
    }

    function splitNightsByMonth(clamped) {
      // recibe {start,end
