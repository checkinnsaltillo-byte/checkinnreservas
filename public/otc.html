<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkinnreservas · Dashboard OTC</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
        :root{
      /* === Theme: Dark (Ocean Neon) === */
      --bg1:#071327;          /* deep ocean */
      --bg2:#0a1e3b;

      --panel:#0c2550;        /* panels */
      --text:#f4f7ff;         /* high contrast */
      --muted:#c7d2fe;        /* soft lavender */

      --line: rgba(129,140,248,.28);

      /* section tints (vivid but harmonic) */
      --tint-params: rgba(34,211,238,.14);   /* cyan */
      --tint-kpis:   rgba(99,102,241,.16);   /* indigo */
      --tint-charts: rgba(244,63,94,.10);    /* rose */
      --tint-table:  rgba(34,197,94,.14);    /* emerald */

      --cardA: rgba(12,37,80,.96);
      --cardB: rgba(10,30,59,.96);

      --shadow: 0 16px 38px rgba(2,6,23,.55);
      --r:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

      --accentAvg:#fb7185; /* rose */
      --accent:#22d3ee;    /* cyan accent */
    }
    [data-theme="light"]{
      /* === Theme: Light (Fresh Sky) === */
      --bg1:#f7fbff;
      --bg2:#eef6ff;

      --panel:#ffffff;
      --text:#0b1b3a;
      --muted:#29406b;

      --line: rgba(37,99,235,.18);

      --tint-params: rgba(14,165,233,.14);
      --tint-kpis:   rgba(79,70,229,.12);
      --tint-charts: rgba(244,63,94,.10);
      --tint-table:  rgba(34,197,94,.12);

      --cardA: rgba(255,255,255,.98);
      --cardB: rgba(245,250,255,.98);

      --shadow: 0 16px 34px rgba(2,6,23,.12);

      --accentAvg:#e11d48;
      --accent:#2563eb;
    }
    :root{
      --panel:#0f1a30; --text:#e8eefc; --muted:#9fb0d0; --line:#1e2b4a;
    --accentAvg:#ff3b30;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --r:16px; --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 40%, var(--bg1) 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:60;
      background:color-mix(in srgb, var(--bg1) 75%, transparent); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1280px; margin:0 auto; padding:16px 18px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, #4cc9f0 0%, #4361ee 55%, #3a0ca3 100%);
      box-shadow: 0 10px 20px rgba(67,97,238,.35);
    }
    h1{font-size:16px; margin:0; font-weight:800; letter-spacing:.2px}
    .sub{margin:2px 0 0; color:var(--muted); font-size:12px}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    button, select, input{
      background:var(--panel); color:var(--text);
      border:1px solid var(--line); border-radius:12px; padding:10px 12px;
      font-size:13px; outline:none;
    }
    button{cursor:pointer}

  /* --- Botones estilo toolbar (similar a principal) --- */
  button{ cursor:pointer; }
  button:hover{ border-color:#2b3c63; }
  button.primary{
    background:linear-gradient(180deg, rgba(76,201,240,.18), rgba(67,97,238,.10));
    border-color:rgba(76,201,240,.35);
  }
  button.ghost{
    background: color-mix(in srgb, var(--panel) 80%, transparent);
    color: var(--text);
    border-color: color-mix(in srgb, var(--accent) 55%, var(--line));
  }
  .contactBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .contactBtns button{ padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:inherit; font-weight:700; font-size:12px; }

    button:hover{border-color:#2b3c63}
    button.primary{
      background:linear-gradient(180deg, rgba(76,201,240,.18), rgba(67,97,238,.10));
      border-color:rgba(76,201,240,.35);
    }
    button.ghost{background:transparent}
    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:rgba(11,18,32,.65); border:1px solid var(--line);
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:999px; background:#64748b}
    .dot.ok{background:#4ade80}
    .dot.err{background:#fb7185}
    .dot.busy{background:#fbbf24}

    .card{
      background:linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-top:14px;
    }
    .hd{
      padding:14px 14px 10px; border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .hd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .hint{margin:3px 0 0; font-size:12px; color:var(--muted)}
    .bd{padding:14px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
    .row > *{flex:1}
    .row .small{flex:.9}
    .row .xsmall{flex:.75}

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      background:rgba(76,201,240,.10);
      border:1px solid rgba(76,201,240,.22);
      color:var(--text);
      font-size:12px;
      white-space:nowrap;
    }

    .kpis{
      display:grid; gap:10px;
      grid-template-columns: repeat(6, 1fr);
    }
    @media (max-width: 1100px){ .kpis{grid-template-columns:repeat(3,1fr)} }
    @media (max-width: 720px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr} }

    .kpi{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,31,58,.7), rgba(15,26,48,.55));
      border-radius:16px;
      padding:12px;
      min-height: 88px;
    }
    .kpi .lbl{font-size:12px; color:var(--muted)}
    .kpi .val{margin-top:6px; font-size:18px; font-weight:900; letter-spacing:.3px}
    .kpi .meta{margin-top:6px; font-size:12px; color:var(--muted)}
  .kpi .mini{margin-top:8px; height:110px; width:100%;}
    .kpi .mini{margin-top:8px; height:110px; width:100%}

    

    /* ======= KPI destacado: Gross + subKPIs ======= */
    .kpiGrossBig{
      border-color: rgba(74,222,128,.35);
      background: linear-gradient(180deg, rgba(74,222,128,.16), rgba(15,26,48,.55));
    }
    .kpiGrossBig .val{ font-size:22px; }
    .kpiNest{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
    }
    .kpiSub{
      border:1px solid rgba(30,43,74,.75);
      background: rgba(11,18,32,.45);
      border-radius:14px;
      padding:10px;
      min-height:64px;
    }
    .kpiSub .lbl{ font-size:11.5px; color:var(--muted); }
    .kpiSub .val{ margin-top:6px; font-size:14px; font-weight:900; letter-spacing:.2px; }
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    .tableWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:rgba(18,31,58,.35);
    }
    table{width:100%; border-collapse:collapse; font-size:12.5px}
    thead{
      position:sticky; top:0;
      background:rgba(11,18,32,.95);
      z-index:5;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(30,43,74,.75);
      vertical-align:top;
      text-align:left;
      white-space:nowrap;
    }
    tbody tr:hover{background:rgba(76,201,240,.06)}
    .scrollY{max-height: 560px; overflow:auto;}
    .footer{padding:14px 18px; color:var(--muted); font-size:12px; border-top:1px solid var(--line);}

    /* ======= OCUPACIÓN: tabla sticky header + sticky first col ======= */
    .occScroll{ max-height: 520px; overflow: auto; }
    #occTable{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size:12.5px;
    }
    #occTable th, #occTable td{
      padding:10px 10px;
      border-bottom:1px solid rgba(30,43,74,.75);
      white-space: nowrap;
    }
    #occTable thead th{
      position: sticky; top: 0; z-index: 7;
      background: rgba(11,18,32,.98);
      border-bottom: 1px solid rgba(30,43,74,.75);
    }
    #occTable .houseCol{
      position: sticky; left: 0; z-index: 6;
      background: rgba(11,18,32,.98);
      border-right: 1px solid rgba(30,43,74,.75);
      font-weight: 800;
    }
    #occTable thead th.houseCol{ z-index: 10; }

    /* --- Ocupación: asegurar sticky para encabezado HouseName --- */
    #occTable thead th.houseCol{
      left: 0;
      position: sticky;
    }


    .occCell{ min-width: 210px; white-space: normal; line-height: 1.25; }
    .occTop{ display:flex; justify-content:space-between; gap:10px; font-size:12px; color:var(--muted); }
    .occMain{ margin-top:6px; display:flex; align-items:center; gap:10px; }
    .bar{
      flex:1; height:10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(76,201,240,.9), rgba(67,97,238,.9));
    }
    #occLineWrap{ overflow:hidden; }

    /* ======= Multi-combobox (dropdown con checks) ======= */
    .mcb{
      position:relative;
      min-width: 220px;
    }
    .mcbBtn{
      width:100%;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mcbBtn span{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color: var(--text);
    }
    .mcbBtn .caret{
      opacity:.8;
      font-size:12px;
      margin-left:8px;
    }
    .mcbPanel{
      position:absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      z-index: 80;
      background: rgba(11,18,32,.98);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow: var(--shadow);
      padding:10px;
      display:none;
    }
    .mcb.open .mcbPanel{ display:block; }
    .mcbSearch{
      width:100%;
      margin-bottom:10px;
      padding:10px 12px;
      border-radius:12px;
    }
    .mcbTools{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .mcbTools button{
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
    }
    .mcbList{
      max-height: 240px;
      overflow:auto;
      border:1px solid rgba(30,43,74,.75);
      border-radius:12px;
      background: rgba(18,31,58,.25);
    }
    .mcbItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:9px 10px;
      border-bottom:1px solid rgba(30,43,74,.55);
    }
    .mcbItem:last-child{ border-bottom:none; }
    .mcbItem:hover{ background: rgba(76,201,240,.06); }
    .mcbItem label{
      display:flex;
      gap:10px;
      align-items:flex-start;
      width:100%;
      cursor:pointer;
      white-space:normal;
      line-height:1.2;
      font-size:12.5px;
    }
    .mcbItem input{ margin-top:2px; }
    .mcbFooter{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }
  
  /* --- Huéspedes: Datos de contacto (mejoras) --- */
  #contactLine { line-height: 1.25; }
  .contactTitle { font-size: 1.25rem; font-weight: 800; margin-bottom: 6px; }
  .contactRow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  a.waLink { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius: 999px; text-decoration:none; font-weight:700; }
  a.waLink:hover { filter: brightness(1.05); }
  .waIcon { width:18px; height:18px; display:inline-block; }
  a.mailLink { text-decoration:none; font-weight:700; padding:6px 10px; border-radius: 999px; }


/* === OVERRIDE: Datos de contacto (Huéspedes) iconos ultra compactos === */
#contactLine { line-height: 1.15 !important; }
.contactRow { align-items: center !important; gap: 6px !important; }
a.waLink, a.mailLink{
  display:inline-flex !important;
  align-items:center !important;
  gap:6px !important;
  padding:4px 8px !important;
  border-radius:999px !important;
  font-weight:700 !important;
  font-size:12px !important;
  line-height:1.05 !important;
  white-space:nowrap !important;
}
.waIcon, .mailIcon, svg.waIcon, svg.mailIcon{
  width:12px !important;
  height:12px !important;
  min-width:12px !important;
  min-height:12px !important;
  flex:0 0 12px !important;
  display:inline-block !important;
  vertical-align:middle !important;
}
a.waLink span, a.mailLink span{ line-height:1.05 !important; }


    /* --- Pair charts: Source + Status side-by-side --- */
    .kpiPair{
      grid-column: 1 / -1;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 900px){
      .kpiPair{ grid-template-columns: 1fr; }
    }
    .kpiPair .kpi .mini{ height: 180px; }


    /* --- Ocupación: fila promedio --- */
    .occAvgRow th, .occAvgRow td{
      background: rgba(255,255,255,0.04);
      font-weight: 800;
    }


    /* --- Variación de fondos por sección (cards) --- */
  .cardA{ background:linear-gradient(180deg, color-mix(in srgb, var(--cardA) 88%, var(--tint-params)), var(--cardB)); }
  .cardB{ background:linear-gradient(180deg, color-mix(in srgb, var(--cardA) 88%, var(--tint-kpis)),   var(--cardB)); }
  .cardC{ background:linear-gradient(180deg, color-mix(in srgb, var(--cardA) 88%, var(--tint-table)),  var(--cardB)); }


  /* === Visual polish === */
  .card{
    border:1px solid var(--line);
    box-shadow: var(--shadow);
  }
  h1,h2,h3{ color: var(--text); }
  .sub{ color: var(--muted); }

  /* section-specific backgrounds (main layout) */
  #panelParams.card{ background: linear-gradient(180deg, color-mix(in srgb, var(--cardA) 88%, var(--tint-params)), var(--cardB)); }
  #panelKPIs.card{ background: linear-gradient(180deg, color-mix(in srgb, var(--cardA) 88%, var(--tint-kpis)),   var(--cardB)); }
  #panelCharts.card{ background: linear-gradient(180deg, color-mix(in srgb, var(--cardA) 88%, var(--tint-charts)), var(--cardB)); }
  #panelTable.card{ background: linear-gradient(180deg, color-mix(in srgb, var(--cardA) 88%, var(--tint-table)),  var(--cardB)); }

  /* KPI tiles */
  .kpi{
    background: linear-gradient(180deg,
      color-mix(in srgb, var(--cardA) 92%, rgba(255,255,255,.06)),
      color-mix(in srgb, var(--cardB) 92%, rgba(0,0,0,.10))
    );
    border:1px solid color-mix(in srgb, var(--line) 85%, transparent);
  }
  .kpi .lbl{ color: color-mix(in srgb, var(--muted) 92%, var(--text)); }

  /* inputs */
  input, select{
    border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
    background: color-mix(in srgb, var(--panel) 90%, var(--bg2));
    color: var(--text);
  }
  ::placeholder{ color: color-mix(in srgb, var(--muted) 78%, transparent); }

  /* buttons */
  button, .btn{
    border:1px solid color-mix(in srgb, var(--line) 90%, transparent);
  }
  button.ghost{
    background: color-mix(in srgb, var(--panel) 85%, transparent);
    color: var(--text);
  }
  button.primary{
    background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(56,189,248,.85));
    border-color: transparent;
    color: white;
  }


/* === MAIN THEME ALIGN (match Huéspedes window) === */
body{
  background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 50%, var(--bg1) 100%);
}
.card{
  background: linear-gradient(180deg, var(--cardA), var(--cardB));
  border:1px solid color-mix(in srgb, var(--line) 85%, transparent);
}


/* === Ocupación: fila de promedio sticky === */
.occScroll{
  max-height: 420px;
  overflow:auto;
  border-radius: 14px;
}
.occTable thead th{
  position: sticky;
  top: 0;
  z-index: 3;
  background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 92%, transparent), color-mix(in srgb, var(--panel) 82%, transparent));
}
.occTable tr.sticky-avg-row td{
  position: sticky;
  bottom: 0;
  z-index: 2;
  background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 88%, var(--tint-kpis)), color-mix(in srgb, var(--panel) 78%, var(--tint-kpis)));
  font-weight: 900;
}

</style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Checkinnreservas · Dashboard OTC</h1>
          <div class="sub">Backend: Cloud Run · <span class="mono" id="baseUrl">same-origin</span></div>
        </div>
      </div>

      <div class="actions">
        <span id="apiStatus" class="status"><span class="dot busy"></span><span>Listo</span></span>
        <!-- Cargar ya no es necesario, lo dejamos como "Recargar" por si quieres forzar fetch -->
        <button id="btnReload" class="primary">Recargar datos</button>
        <button id="btnCsv">Descargar CSV</button>
        <button id="btnDebug" class="ghost">Debug</button>
        <button id="btnGuests" class="ghost">Huéspedes</button>
        <button id="themeToggle" class="ghost" title="Cambiar modo claro/oscuro">Modo: Oscuro</button>

      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- Parámetros -->
  <section class="card cardA" style="overflow:visible;" id="panelParams">
    <div class="hd">
      <div>
        <h2>Parámetros</h2>
        <div class="hint">
          API: <span class="mono">/api/otc</span> y <span class="mono">/api/otc.csv</span> · Fechas incluyen overlap.
          Los filtros aplican al instante.
        </div>
      </div>
      <div class="hint" id="metaLine">—</div>
    </div>

    <div class="bd">
      <div class="row">
        <label style="flex:1">
          <div class="hint">Desde</div>
          <input id="from" type="date" />
        </label>
        <label style="flex:1">
          <div class="hint">Hasta</div>
          <input id="to" type="date" />
        </label>

        <label class="small">
          <div class="hint">Buscar</div>
          <input id="q" placeholder="Guest / House / Id / Source / LineItem..." />
        </label>

        <!-- ✅ combobox multi: Propiedad -->
        <div class="mcb" id="mcbPropiedad" style="flex:1.2">
          <div class="hint">Propiedad</div>
          <button class="mcbBtn" type="button">
            <span class="mcbLabel">Todas</span>
            <span class="caret">▾</span>
          </button>
          <div class="mcbPanel">
            <input class="mcbSearch" type="text" placeholder="Buscar propiedad..." />
            <div class="mcbTools">
              <button type="button" class="mcbAll">Seleccionar todo</button>
              <button type="button" class="mcbNone">Limpiar</button>
            </div>
            <div class="mcbList"></div>
            <div class="mcbFooter">
              <span class="mcbCount">0 seleccionados</span>
              <button type="button" class="mcbClose">Cerrar</button>
            </div>
          </div>
        </div>

        <label class="xsmall">
          <div class="hint">Source</div>
          <select id="selSource">
            <option value="">Todos</option>
          </select>
        </label>

        <label class="xsmall">
          <div class="hint">Status</div>
          <select id="selStatus">
            <option value="">Todos</option>
          </select>
        </label>
      </div>

      <div class="hint" style="margin-top:10px">
        Tip: “Propiedad” es multiselección con checks. Si no seleccionas nada, se asume “todas”.
      </div>
    </div>
  </section>

  <!-- KPIs + mini charts por monto -->
  <section class="card" id="panelKPIs">
    <div class="hd">
      <div>
        <h2>KPIs</h2>
        <div class="hint">Montos por LineItem + gráficas por <b>monto</b> (sum GrossAmount). Incluye etiquetas en barras.</div>
      </div>
      <div class="hint"><span class="pill" id="pillFiltered">0 filas</span></div>
    </div>

    <div class="bd">
      <div class="kpis">
        <div class="kpi">
          <div class="lbl">Reservas únicas</div>
          <div class="val" id="kpiBookings">—</div>
          <div class="meta">IDs distintos</div>
        </div>

        <div class="kpi">
          <div class="lbl">Noches (sum)</div>
          <div class="val" id="kpiNights">—</div>
          <div class="meta">Suma Nights</div>
        </div>


        <div class="kpi">
          <div class="lbl">Huéspedes únicos</div>
          <div class="val" id="kpiGuests">—</div>
          <div class="meta">Por teléfono o nombre</div>
        </div>

        <div class="kpi">
          <div class="lbl">Precio / noche (prom)</div>
          <div class="val" id="kpiAvgNight">—</div>
          <div class="meta">Gross / Nights</div>
        </div>

                <div class="kpi kpiGrossBig">
          <div class="lbl">Gross (sum)</div>
          <div class="val" id="kpiGross">—</div>
          <div class="meta">Suma GrossAmount</div>

          <div class="kpiNest">
            <div class="kpiSub">
              <div class="lbl">RoomRate</div>
              <div class="val" id="kpiRoomRate">—</div>
            </div>
            <div class="kpiSub">
              <div class="lbl">Fee</div>
              <div class="val" id="kpiFee">—</div>
            </div>
            <div class="kpiSub">
              <div class="lbl">Tax</div>
              <div class="val" id="kpiTax">—</div>
            </div>
          </div>
        </div>
</div>
</div>
</div>

        
        <div class="kpiPair">
          <div class="kpi" >
          <div class="lbl">Monto por Source</div>
          <div class="meta">Barras (sum GrossAmount, top 12) + etiquetas</div>
          <div class="mini"><canvas id="chSourceBar"></canvas></div>
        </div>
          <div class="kpi" >
          <div class="lbl">Monto por Status</div>
          <div class="meta">Barras (sum GrossAmount, top 12) + etiquetas</div>
          

        <div class="kpi" id="kpiSourcesMini" style="grid-column: span 4;">
          <div class="lbl">Reservas por Source</div>
          <div class="meta">Distribución por canal</div>
          <div class="mini" style="height:120px; margin-top:8px;"><canvas id="chSources"></canvas></div>
        </div>

        <!-- Fila 2 -->
        <div class="kpi" style="grid-column: span 3;">
          <div class="lbl">Monto pagado (Gross)</div>
          <div class="val" id="kpiGross">—</div>
          <div class="meta">Suma de line-items por reserva</div>
        </div>

        <div class="kpi" style="grid-column: span 2;">
          <div class="lbl">Reservas</div>
          <div class="val" id="kpiBookings">—</div>
          <div class="meta">IDs distintos</div>
        </div>

        <div class="kpi" style="grid-column: span 2;">
          <div class="lbl">Noches</div>
          <div class="val" id="kpiNights">—</div>
          <div class="meta">Suma Nights</div>
        </div>

        <div class="kpi" style="grid-column: span 2;">
          <div class="lbl">Alojamientos distintos</div>
          <div class="val" id="kpiHouses">—</div>
          <div class="meta">HouseName únicos</div>
        </div>

        <div class="kpi" style="grid-column: span 3;">
          <div class="lbl">Primera / última reserva</div>
          <div class="val" id="kpiFirstLast" style="font-size:13px; line-height:1.35">—</div>
          <div class="meta">Fechas de llegada (DateArrival)</div>
        </div>
      </div>
    </div>
  </section>

  <section class="card cardC">
    <div class="hd">
      <div>
        <h2>Historial de reservas (del universo actual)</h2>
        <div class="hint">Se deduplica por Id y suma el Gross por reserva.</div>
      </div>
    </div>
    <div class="bd">
      <div class="tableWrap">
        <div class="scrollY">
          <table>
            <thead>
              <tr>
                <th>Id</th>
                <th>Arrival</th>
                <th>Departure</th>
                <th>Property</th>
                <th>HouseName</th>
                <th>Source</th>
                <th>Status</th>
                <th>Gross</th>
              </tr>
            </thead>
            <tbody id="tbBookings"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  const $ = (id)=>document.getElementById(id);

  function moneyMXN(v){
    const n = Number(v);
    if(!Number.isFinite(n)) return "—";
    try{ return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(n); }
    catch{ return "$" + n.toFixed(2); }
  }

  function fmtYMD(ts){
    if(!ts) return "—";
    try{ return new Date(ts).toISOString().slice(0,10); }
    catch(e){ return "—"; }
  }


  function safeStr(v){ return (v===null || v===undefined) ? "" : String(v); }

  function normalizeText(s){
    return safeStr(s)
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/\s+/g," ")
      .trim();
  }

  function onlyDigits(s){ return safeStr(s).replace(/\D/g,""); }

  function starText(n){
    const s = "★★★★★".slice(0, Math.max(0, Math.min(5, n||0)));
    const e = "☆☆☆☆☆".slice(0, 5 - s.length);
    return s + e;
  }

  function applyGuestTheme(){
    const theme = (localStorage.getItem("theme") || "dark");
    document.documentElement.setAttribute("data-theme", theme);
    if(window.Chart){
      const cs = getComputedStyle(document.documentElement);
      const text = cs.getPropertyValue("--text").trim() || "#e8eefc";
      const muted = cs.getPropertyValue("--muted").trim() || "#9fb0d0";
      const line = cs.getPropertyValue("--line").trim() || "#1e2b4a";
      Chart.defaults.color = text;
      Chart.defaults.borderColor = line;
      Chart.defaults.plugins.legend.labels.color = text;
      Chart.defaults.scale.grid.color = line;
      Chart.defaults.scale.ticks.color = muted;
    }
  }

  let profiles = (window.opener && window.opener.__guestProfiles) ? window.opener.__guestProfiles : [];
  let selected = null;
  let chSources = null;

  function labelForGuest(g){
    const nm = g.GuestName && g.GuestName !== "—" ? g.GuestName : "(Sin nombre)";
    const ph = g.GuestPhone ? (" · " + g.GuestPhone) : "";
    return nm + ph;
  }

  function scoreMatch(q, g){
    const qn = normalizeText(q);
    const qd = onlyDigits(q);

    const nm = normalizeText(g.GuestName);
    const em = normalizeText(g.GuestEmail);
    const ph = onlyDigits(g.GuestPhone);

    if(qd && ph && ph.includes(qd)) return 1000 - (ph.indexOf(qd) || 0);
    if(qn && (nm === qn)) return 950;
    if(qn && nm.includes(qn)) return 900 - (nm.indexOf(qn) || 0);
    if(qn && em.includes(qn)) return 700;
    // token match
    if(qn){
      const toks = qn.split(" ").filter(Boolean);
      let hit = 0;
      for(const t of toks){
        if(nm.includes(t)) hit += 1;
      }
      if(hit) return 500 + hit*30;
    }
    return 0;
  }

  function renderList(){
    const combo = $("comboGuest");
    const input = $("guestInput");
    const list = $("guestList");
    const q = input.value.trim();

    let items = profiles.map(g=>({ g, s: q ? scoreMatch(q,g) : 1 }));
    if(q) items = items.filter(x=>x.s>0).sort((a,b)=>b.s-a.s);
    else items = items.sort((a,b)=> (b.g.score-a.g.score));

    const top = items.slice(0, 80);

    list.innerHTML = top.map(({g})=>{
      const nm = labelForGuest(g);
      const right = \`\${starText(g.stars)} · \${g.score}\`;
      return \`<div class="comboItem" data-key="\${g.guestKey}">
        <div>
          <div>\${escapeHtml(nm)}</div>
          <div class="tag">\${g.bookings.length} reservas · \${moneyMXN(g.totalGross)} · \${g.houses.size} aloj. · \${fmtYMD(g.firstArrivalTs)} → \${fmtYMD(g.lastArrivalTs)}</div>
        </div>
        <div class="tag">\${escapeHtml(right)}</div>
      </div>\`;
    }).join("") || \`<div class="comboItem"><span class="tag">Sin resultados</span></div>\`;

    list.querySelectorAll(".comboItem[data-key]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const key = el.getAttribute("data-key");
        selectGuest(key);
        combo.classList.remove("open");
      });
    });
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  
  // --- Stars (semáforo) ---
  function semaforoColor(score){
    var s = Math.max(0, Math.min(100, Number(score)||0));
    if(s <= 50){
      var t = s/50; // 0..1
      var r = 220;
      var g = Math.round(60 + t*(200-60)); // 60 -> 200
      var b = 60;
      return "rgb(" + r + "," + g + "," + b + ")";
    }else{
      var t2 = (s-50)/50; // 0..1
      var r2 = Math.round(220 + t2*(70-220)); // 220 -> 70
      var g2 = 200;
      var b2 = 70;
      return "rgb(" + r2 + "," + g2 + "," + b2 + ")";
    }
  }

  function renderStars(stars, score){
    var n = Math.max(0, Math.min(5, Math.round(Number(stars)||0)));
    var fill = semaforoColor(score);
    var html = '<span class="stars" aria-label="calificación">';
    for(var i=1;i<=5;i++){
      if(i<=n){
        html += '<span class="star" style="color:'+fill+'; text-shadow:0 0 12px rgba(0,0,0,.25)">★</span>';
      }else{
        html += '<span class="star" style="color:rgba(159,176,208,.35)">★</span>';
      }
    }
    html += '</span>';
    return html;
  }

function selectGuest(key){

  // --- WhatsApp helpers (Huéspedes) ---
  function waDigits(raw){
    var d = String(raw || "").replace(/\D/g, "");
    // Si es MX sin lada (10 dígitos), antepone 52
    if(d.length === 10) d = "52" + d;
    return d;
  }
  function waIconHTML(){
    return '<svg class="waIcon" viewBox="0 0 32 32" aria-hidden="true" focusable="false">'
      + '<path d="M19.11 17.33c-.27-.14-1.6-.79-1.85-.88-.25-.09-.43-.14-.61.14-.18.27-.7.88-.86 1.06-.16.18-.31.2-.58.07-.27-.14-1.14-.42-2.17-1.33-.8-.71-1.34-1.58-1.5-1.85-.16-.27-.02-.41.12-.54.12-.12.27-.31.41-.47.14-.16.18-.27.27-.45.09-.18.05-.34-.02-.47-.07-.14-.61-1.47-.84-2.01-.22-.53-.45-.46-.61-.46h-.52c-.18 0-.47.07-.72.34-.25.27-.95.93-.95 2.27 0 1.34.98 2.64 1.12 2.82.14.18 1.92 2.93 4.66 4.11.65.28 1.16.45 1.55.58.65.21 1.25.18 1.72.11.52-.08 1.6-.65 1.83-1.28.23-.63.23-1.17.16-1.28-.07-.11-.25-.18-.52-.32z"/>'
      + '<path d="M16 3C8.83 3 3 8.63 3 15.59c0 2.45.74 4.72 2.01 6.64L3 29l6.96-1.91c1.83 1 3.94 1.57 6.19 1.57 7.17 0 13-5.63 13-12.59C29 8.63 23.17 3 16 3zm0 23.04c-2.08 0-4.03-.57-5.7-1.56l-.41-.24-4.13 1.13 1.1-3.98-.27-.4c-1.07-1.59-1.64-3.44-1.64-5.39 0-5.49 4.66-9.95 10.38-9.95 5.73 0 10.38 4.46 10.38 9.95 0 5.49-4.66 9.95-10.38 9.95z"/>'
      + '</svg>';
  }


    selected = profiles.find(g=>g.guestKey === key) || null;
    if(!selected) return;

    $("pillSelected").textContent = labelForGuest(selected);
    $("kpiStars").innerHTML = renderStars(selected.stars, selected.score);
    $("kpiScore").textContent = \`Score: \${selected.score}/100\`;
    $("kpiBookings").textContent = String(selected.bookings.length);
    $("kpiGross").textContent = moneyMXN(selected.totalGross);
    $("kpiNights").textContent = String(selected.totalNights);
    $("kpiHouses").textContent = String(selected.houses.size);
    $("kpiFirstLast").innerHTML = "<div><b>Primera:</b> " + fmtYMD(selected.firstArrivalTs) + "</div><div><b>Última:</b> " + fmtYMD(selected.lastArrivalTs) + "</div>";

    // ✅ Título grande: nombre del huésped seleccionado (del combo)
    var titleEl = document.getElementById("guestTitleBig");
    var nameForTitle = (selected.GuestName && selected.GuestName !== "—") ? selected.GuestName : "Huésped";
    if (titleEl) titleEl.textContent = nameForTitle;

        const name = selected.GuestName || "Huésped";
    const phoneRaw = selected.GuestPhone || "";
    const emailRaw = selected.GuestEmail || "";

    var phoneDigits = waDigits(phoneRaw);
    var phoneHtml = "";
    if(phoneRaw){
      phoneHtml = '<a class="waLink" href="https://wa.me/' + phoneDigits + '" target="_blank" rel="noopener noreferrer" title="Enviar mensaje por WhatsApp">'
        + waIconHTML() + '<span>' + esc(phoneRaw) + '</span></a>';
    }
    var emailHtml = "";
    if(emailRaw){
      emailHtml = '<a class="mailLink" href="mailto:' + esc(emailRaw) + '" title="Enviar correo">' + esc(emailRaw) + '</a>';
    }

    $("contactLine").innerHTML =
  '<div class="contactTitle">' + esc(name) + '</div>' +
  '<div class="contactRow">' +
    (phoneRaw ? '<span class="mono">Tel: ' + esc(phoneRaw) + '</span>' : '') +
    (emailRaw ? (phoneRaw ? ' <span class="muted">·</span> ' : '') + '<span class="mono">Email: ' + esc(emailRaw) + '</span>' : '') +
  '</div>' +
  '<div class="contactBtns">' +
    (phoneRaw ? '<button id="btnGuestWA" class="ghost" type="button">Enviar WhatsApp</button>' : '') +
    (emailRaw ? '<button id="btnGuestMail" class="ghost" type="button">Enviar E-mail</button>' : '') +
  '</div>';

setTimeout(function(){
  var bW = document.getElementById("btnGuestWA");
  if(bW){ bW.onclick = function(){ window.open("https://wa.me/" + phoneDigits, "_blank"); }; }
  var bM = document.getElementById("btnGuestMail");
  if(bM){ bM.onclick = function(){ window.location.href = "mailto:" + emailRaw; }; }
}, 0);
renderSourcesChart(selected);
    renderBookingsTable(selected);
  }


  function esc(s){
    return String(s==null? "" : s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }


  function renderSourcesChart(g){
    const labels = [...g.sources.keys()];
    labels.sort((a,b)=> (g.sources.get(b).count - g.sources.get(a).count));
    const data = labels.map(k=> g.sources.get(k).count);

    // plugin: value labels (horizontal bar)
    const barValueLabelsGuest = {
      id: "barValueLabelsGuest",
      afterDatasetsDraw(chart){
        const { ctx } = chart;
        ctx.save();
        ctx.fillStyle = "rgba(232,238,252,.95)";
        ctx.font = "11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
        ctx.textBaseline = "middle";

        const ds = chart.data.datasets[0];
        const meta = chart.getDatasetMeta(0);
        meta.data.forEach((el, i)=>{
          const v = ds.data[i];
          if(v === null || v === undefined) return;
          const p = el.tooltipPosition();
          // In horizontal bars, tooltipPosition() is near end of bar; nudge a bit right.
          ctx.textAlign = "left";
          ctx.fillText(String(v), p.x + 6, p.y);
        });
        ctx.restore();
      }
    };

    if(chSources) chSources.destroy();
    chSources = new Chart(document.getElementById("chSources"), {
      type:"bar",
      data:{ labels, datasets:[{ label:"Reservas", data }] },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        indexAxis: "y",
        plugins:{ legend:{ display:false
          onClick: occLegendClick,
},
          tooltip:{ callbacks:{ label:(ctx)=> " " + ctx.raw + " reservas" } }
        },
        scales:{
          x:{ beginAtZero:true, ticks:{ precision:0, font:{ size:10 } } },
          y:{ ticks:{ autoSkip:false, font:{ size:10 } } }
        }
      },
      plugins:[barValueLabelsGuest]
    });
  }

  function renderBookingsTable(g){
    const tb = $("tbBookings");
    const arr = [...g.bookings].sort((a,b)=> (new Date(a.DateArrival).getTime() - new Date(b.DateArrival).getTime()));
    tb.innerHTML = arr.map(b=>{
      return \`<tr>
        <td class="mono">\${escapeHtml(b.id)}</td>
        <td class="mono">\${escapeHtml(b.DateArrival || "—")}</td>
        <td class="mono">\${escapeHtml(b.DateDeparture || "—")}</td>
        <td>\${escapeHtml(b.Property || "—")}</td>
        <td title="\${escapeHtml(b.HouseName||"")}">\${escapeHtml(b.HouseName || "—")}</td>
        <td>\${escapeHtml(b.Source || "—")}</td>
        <td>\${escapeHtml(b.Status || "—")}</td>
        <td class="mono">\${moneyMXN(b.Gross)}</td>
      </tr>\`;
    }).join("") || \`<tr><td colspan="8" class="tag">Sin reservas</td></tr>\`;
  }

  function refreshFromOpener(){
    profiles = (window.opener && window.opener.__guestProfiles) ? window.opener.__guestProfiles : [];
    $("pillUniverse").textContent = \`\${profiles.length} huéspedes\`;
    // si ya había selección, intenta mantenerla
    const key = selected?.guestKey;
    renderList();
    if(key){
      const still = profiles.find(g=>g.guestKey===key);
      if(still) selectGuest(key);
      else $("pillSelected").textContent = "—";
    }
  }

  function startApp(){
    applyGuestTheme();
    // Título inicial (sin selección)
    const t0=document.getElementById('guestTitleBig'); if(t0) t0.textContent='Indicadores del huésped';
    const combo = $("comboGuest");
    const input = $("guestInput");

    $("pillUniverse").textContent = \`\${profiles.length} huéspedes\`;
    $("pillSelected").textContent = "—";

    function open(){ combo.classList.add("open"); renderList(); }
    function close(){ combo.classList.remove("open"); }

    input.addEventListener("focus", open);
    input.addEventListener("input", ()=>{ open(); renderList(); });

    document.addEventListener("click", (e)=>{
      if(!combo.contains(e.target)) close();
    });

    $("btnClose").addEventListener("click", ()=> window.close());
    $("btnRefresh").addEventListener("click", ()=> refreshFromOpener());

    // Sin selección por defecto: el usuario elige en el combo
  }
  if(window.Chart) startApp();
  else window.addEventListener('chartjs:ready', startApp, { once:true });
<\/script>
</body>
</html>`;

    doc.open();
    doc.write(html);
    doc.close();
  }


  (function init(){
    $("baseUrl").textContent = API_BASE || "same-origin";
    setDefaultDates();

    // Theme init
    setTheme(getTheme());


    // init multi-comboboxes
    initMCB("mcbPropiedad", { emptyLabel:"Todas", onChange: ()=> applyLocalFilters() });
    initMCB("mcbOccPropiedad", { emptyLabel:"Todas", onChange: ()=> renderOccupancyByMonth() });
    initMCB("mcbOccAvgMonths", { emptyLabel:"Todos", onChange: ()=> renderOccupancyByMonth() });
    initMCB("mcbOccHouses", { emptyLabel:"Todos", onChange: ()=> renderOccupancyByMonth() });

    // botones header
    $("btnReload").addEventListener("click", async ()=>{
      try{ await fetchOTC(); }
      catch(e){ setStatus("err","Error"); alert(String(e.message || e)); }
    });
    $("btnCsv").addEventListener("click", downloadCSV);
    $("btnDebug").addEventListener("click", loadDebug);
    $("btnGuests").addEventListener("click", openGuestsWindow);

    $("themeToggle").addEventListener("click", ()=>{
      const cur = getTheme();
      setTheme(cur === "dark" ? "light" : "dark");
    });

    // filtros instantáneos: cuando cambias fechas, se hace fetch inmediato (porque cambia el universo)
    // debounce para no spamear el backend
    let tFetch = null;
    function scheduleFetch(){
      clearTimeout(tFetch);
      tFetch = setTimeout(()=>{
        fetchOTC().catch(e=>{ setStatus("err","Error"); alert(String(e.message || e)); });
      }, 250);
    }

    ["from","to"].forEach(id=>{
      $(id).addEventListener("change", scheduleFetch);
      $(id).addEventListener("input", scheduleFetch);
    });

    // filtros locales (no requieren fetch)
    ["q","selSource","selStatus"].forEach(id=>{
      $(id).addEventListener("input", applyLocalFilters);
      $(id).addEventListener("change", applyLocalFilters);
    });

    // vista ocupación
    $("occView").addEventListener("change", syncOccView);

    // ✅ carga inicial automática (ya no necesitas "Cargar")
    fetchOTC().catch(e=>{
      setStatus("err","Error");
      alert(String(e.message || e));
    });
  })();
</script>
</body>
</html>

// ---- Metodología de evaluación (actualizada) ----
// Score = 0.6 * scoreReservas + 0.4 * scoreMonto
function calcularScoreHuesped(scoreReservas, scoreMonto){
  return (0.6 * scoreReservas) + (0.4 * scoreMonto);
}
