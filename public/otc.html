app.get("/api/otc.csv", async (req, res) => {
  try {
    const fromISO = String(req.query.from || "");
    const toISO = String(req.query.to || "");
    if (!parseISODate(fromISO) || !parseISODate(toISO)) {
      return res.status(400).send("Use query params: ?from=YYYY-MM-DD&to=YYYY-MM-DD");
    }

    const limit = Math.min(200, Math.max(10, Number(req.query.limit || 50)));

    const bufferDays = Number(req.query.bufferDays || 45);
    const fromD = parseISODate(fromISO);
    const toD = parseISODate(toISO);

    const fetchFrom = new Date(fromD);
    fetchFrom.setUTCDate(fetchFrom.getUTCDate() - bufferDays);

    const fetchTo = new Date(toD);
    fetchTo.setUTCDate(fetchTo.getUTCDate() + bufferDays);

    const fetchFromISO = fetchFrom.toISOString().slice(0, 10);
    const fetchToISO = fetchTo.toISOString().slice(0, 10);

    const [propsMap, bookings] = await Promise.all([
      fetchPropertiesMap(),
      fetchAllBookings({ fromISO: fetchFromISO, toISO: fetchToISO, limit }),
    ]);

    const rows = buildOTCRows({ bookings, propsMap, fromISO, toISO });
    const csv = rowsToCSV(rows);

    res.setHeader("Content-Type", "text/csv; charset=utf-8");
    res.setHeader("Content-Disposition", `attachment; filename="OTCReport_${fromISO}_to_${toISO}.csv"`);
    res.send(csv);
  } catch (e) {
    const code = e?.statusCode ? Number(e.statusCode) : 500;
    res.status(code).send(String(e?.message || e));
  }
});
