<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkinnreservas · Dashboard OTC</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a30; --panel2:#121f3a;
      --text:#e8eefc; --muted:#9fb0d0; --line:#1e2b4a;
      --accent:#4cc9f0; --good:#4ade80; --warn:#fbbf24; --bad:#fb7185;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --r:16px; --r2:12px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      background:linear-gradient(180deg,#070b15 0%, #0b1220 40%, #070b15 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:20;
      background:rgba(7,11,21,.75); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1280px; margin:0 auto; padding:16px 18px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, #4cc9f0 0%, #4361ee 55%, #3a0ca3 100%);
      box-shadow: 0 10px 20px rgba(67,97,238,.35);
    }
    h1{font-size:16px; margin:0; font-weight:800; letter-spacing:.2px}
    .sub{margin:2px 0 0; color:var(--muted); font-size:12px}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    button, select, input{
      background:var(--panel); color:var(--text);
      border:1px solid var(--line); border-radius:12px; padding:10px 12px;
      font-size:13px; outline:none;
    }
    button{cursor:pointer}
    button:hover{border-color:#2b3c63}
    button.primary{
      background:linear-gradient(180deg, rgba(76,201,240,.18), rgba(67,97,238,.10));
      border-color:rgba(76,201,240,.35);
    }
    button.primary:hover{border-color:rgba(76,201,240,.6)}
    button.ghost{background:transparent}
    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:rgba(11,18,32,.65); border:1px solid var(--line);
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:999px; background:#64748b}
    .dot.ok{background:var(--good)}
    .dot.err{background:var(--bad)}
    .dot.busy{background:var(--warn)}
    .card{
      background:linear-gradient(180deg, rgba(15,26,48,.98), rgba(11,18,32,.98));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-top:14px;
    }
    .hd{
      padding:14px 14px 10px; border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .hd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .hd .hint{margin:3px 0 0; font-size:12px; color:var(--muted)}
    .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
    .row > *{flex:1}
    .row .small{flex:.8}
    .kpis{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr} }
    .kpi{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,31,58,.7), rgba(15,26,48,.55));
      border-radius:16px;
      padding:12px;
    }
    .kpi .lbl{font-size:12px; color:var(--muted)}
    .kpi .val{margin-top:6px; font-size:20px; font-weight:900; letter-spacing:.3px}
    .kpi .meta{margin-top:6px; font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      background:rgba(76,201,240,.10);
      border:1px solid rgba(76,201,240,.22);
      color:var(--text);
      font-size:12px;
      white-space:nowrap;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .tableWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:rgba(18,31,58,.35);
    }
    table{width:100%; border-collapse:collapse; font-size:12.5px}
    thead{
      position:sticky; top:0;
      background:rgba(11,18,32,.95);
      z-index:5;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(30,43,74,.75);
      vertical-align:top;
      text-align:left;
      white-space:nowrap;
    }
    tbody tr:hover{background:rgba(76,201,240,.06)}
    .scrollY{max-height: 560px; overflow:auto;}
    .footer{padding:14px 18px; color:var(--muted); font-size:12px; border-top:1px solid var(--line);}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Checkinnreservas · Dashboard OTC</h1>
          <div class="sub">Backend: Cloud Run · <span class="mono" id="baseUrl">same-origin</span></div>
        </div>
      </div>

      <div class="actions">
        <span id="apiStatus" class="status"><span class="dot busy"></span><span>Listo</span></span>
        <button id="btnLoad" class="primary">Cargar</button>
        <button id="btnCsv">Descargar CSV</button>
        <button id="btnDebug" class="ghost">Debug</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- Parámetros + KPIs -->
  <section class="card">
    <div class="hd">
      <div>
        <h2>Parámetros</h2>
        <div class="hint">
          API: <span class="mono">/api/otc</span> y <span class="mono">/api/otc.csv</span>
          · La selección por fechas incluye reservas que <b>toquen</b> el rango (overlap).
        </div>
      </div>
      <div class="hint" id="metaLine">—</div>
    </div>

    <div class="bd">
      <div class="row">
        <label style="flex:1">
          <div class="hint">Desde</div>
          <input id="from" type="date" />
        </label>
        <label style="flex:1">
          <div class="hint">Hasta</div>
          <input id="to" type="date" />
        </label>
        <label class="small">
          <div class="hint">Buscar</div>
          <input id="q" placeholder="Guest / House / Id / Source..." />
        </label>
        <label class="small">
          <div class="hint">Source</div>
          <select id="selSource">
            <option value="">Todos</option>
          </select>
        </label>
      </div>

      <div style="height:12px"></div>

      <div class="kpis">
        <div class="kpi">
          <div class="lbl">Reservas únicas</div>
          <div class="val" id="kpiBookings">—</div>
          <div class="meta">IDs distintos</div>
        </div>
        <div class="kpi">
          <div class="lbl">Noches (sum)</div>
          <div class="val" id="kpiNights">—</div>
          <div class="meta">Suma Nights (en rango)</div>
        </div>
        <div class="kpi">
          <div class="lbl">Gross (sum)</div>
          <div class="val" id="kpiGross">—</div>
          <div class="meta">Suma GrossAmount (prorrateado)</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Gráficas ARRIBA -->
  <section class="card">
    <div class="hd">
      <div>
        <h2>Gráficas</h2>
        <div class="hint">Distribución por Source (filtrado local)</div>
      </div>
    </div>
    <div class="bd">
      <canvas id="chSource"></canvas>
      <div style="height:10px"></div>
      <div class="hint">
        Si quieres otras gráficas (HouseName / Status / LineItem), dímelo y las agrego.
      </div>
    </div>
  </section>

  <!-- Tabla ABAJO -->
  <section class="card">
    <div class="hd">
      <div>
        <h2>Tabla OTC</h2>
        <div class="hint">
          La tabla ya viene completa de la API; además aplicamos filtro local (search/source) y overlap por fechas.
        </div>
      </div>
      <div class="hint">
        <span class="pill" id="pillFiltered">0 filas</span>
      </div>
    </div>
    <div class="bd">
      <div class="tableWrap">
        <div class="scrollY">
          <table>
            <thead>
              <tr>
                <th>Id</th>
                <th>Source</th>
                <th>Status</th>
                <th>Arrival</th>
                <th>Departure</th>
                <th>Nights</th>
                <th>HouseName</th>
                <th>GuestName</th>
                <th>LineItem</th>
                <th>GrossAmount</th>
                <th>Currency</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="footer">
      Export CSV usa: <span class="mono">/api/otc.csv</span>
    </div>
  </section>

</main>

<script>
  // =========================
  // Base URL
  // =========================
  // Recomendado: same-origin (porque el HTML lo sirve Cloud Run también).
  // Si algún día lo abres desde GitHub Pages, pon aquí:
  // const API_BASE = "https://checkinnreservas-1044570371371.northamerica-south1.run.app";
  const API_BASE = "";

  // =========================
  // State
  // =========================
  let rowsRaw = [];
  let rowsFiltered = [];
  let chSource = null;
  let lastMeta = null;

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);

  function setStatus(kind, text){
    const el = $("apiStatus");
    const dot = el.querySelector(".dot");
    dot.classList.remove("ok","err","busy");
    dot.classList.add(kind);
    el.lastElementChild.textContent = text;
  }

  function moneyMXN(v){
    const n = Number(v);
    if(!Number.isFinite(n)) return "—";
    try{
      return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(n);
    }catch{
      return "$" + n.toFixed(2);
    }
  }

  function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }
  function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

  // --- Date parsing for overlap ---
  // Arrival/Departure vienen como "MM/DD/YYYY" por tu server (formatMMDDYYYY).
  function parseMMDDYYYY(s){
    const t = safeStr(s).trim();
    if(!t) return null;
    const m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(!m) return null;
    const mm = Number(m[1]), dd = Number(m[2]), yyyy = Number(m[3]);
    if(!mm || !dd || !yyyy) return null;
    // Usar UTC para evitar shifts
    return new Date(Date.UTC(yyyy, mm-1, dd, 0, 0, 0));
  }

  function parseISODateInput(s){
    const t = safeStr(s).trim();
    if(!t) return null;
    const m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const yyyy = Number(m[1]), mm = Number(m[2]), dd = Number(m[3]);
    return new Date(Date.UTC(yyyy, mm-1, dd, 0, 0, 0));
  }

  // overlap: [aStart, aEnd) toca [bStart, bEnd) si aStart < bEnd && bStart < aEnd
  // (Departure se trata como end exclusivo)
  function overlaps(arrivalMMDD, departureMMDD, fromISO, toISO){
    const aStart = parseMMDDYYYY(arrivalMMDD);
    const aEnd   = parseMMDDYYYY(departureMMDD);
    const bStart = parseISODateInput(fromISO);
    const bEnd   = parseISODateInput(toISO);

    if(!aStart || !aEnd || !bStart || !bEnd) return true;

    // Convertir bEnd a "día siguiente" para que sea inclusivo en UI (si eliges 2026-01-31, incluye ese día).
    const bEndEx = new Date(bEnd.getTime());
    bEndEx.setUTCDate(bEndEx.getUTCDate() + 1);

    return (aStart < bEndEx) && (bStart < aEnd);
  }

  function qs(){
    // Ya NO mandamos size.
    const from = $("from").value;
    const to = $("to").value;
    return new URLSearchParams({ from, to }).toString();
  }

  function normalizeRow(r){
    return {
      Id: r.Id,
      Source: r.Source,
      Status: r.Status,
      DateArrival: r.DateArrival,
      DateDeparture: r.DateDeparture,
      Nights: safeNum(r.Nights),
      HouseName: r.HouseName,
      GuestName: r.GuestName,
      LineItem: r.LineItem,
      GrossAmount: safeNum(r.GrossAmount),
      Currency: r.Currency,
      _raw: r
    };
  }

  // =========================
  // Load
  // =========================
  async function loadOTC(){
    setStatus("busy", "Cargando...");
    $("metaLine").textContent = "—";
    lastMeta = null;

    const url = `${API_BASE}/api/otc?${qs()}`;
    const res = await fetch(url, { headers: { "Accept":"application/json" } });
    const data = await res.json();

    if(!res.ok || !data?.ok){
      setStatus("err", "Error");
      throw new Error(data?.error || `HTTP ${res.status}`);
    }

    lastMeta = data;
    rowsRaw = (data.rows || []).map(normalizeRow);

    setStatus("ok", `OK · ${rowsRaw.length} filas`);
    const metaBits = [
      `bookingsFetched=${data.bookingsFetched ?? "?"}`,
      `pagesUsed=${data.pagesUsed ?? "?"}`,
      `effectivePageSize=${data.effectivePageSize ?? "?"}`,
      `totalCount=${data.totalCount ?? "?"}`
    ];
    $("metaLine").textContent = metaBits.join(" · ");

    rebuildSourceFilter();
    applyLocalFilters();
  }

  async function loadDebug(){
    setStatus("busy", "Debug...");
    const url = `${API_BASE}/api/debug/bookings`; // el endpoint soporta ?size, pero ya no lo necesitamos aquí
    const res = await fetch(url, { headers: { "Accept":"application/json" } });
    const data = await res.json();
    if(!res.ok || !data?.ok){
      setStatus("err","Debug error");
      alert(data?.error || `HTTP ${res.status}`);
      return;
    }
    setStatus("ok","Debug OK");
    alert(
      [
        "Debug paginación Lodgify",
        `effectivePageSize: ${data.effectivePageSize}`,
        `pagesUsed: ${data.pagesUsed}`,
        `totalCount: ${data.totalCount}`,
        `bookingsFetched: ${data.bookingsFetched}`,
        `arrivalMin: ${data.arrivalMin}`,
        `arrivalMax: ${data.arrivalMax}`,
      ].join("\n")
    );
  }

  // =========================
  // Local filters + render
  // =========================
  function rebuildSourceFilter(){
    const sel = $("selSource");
    const cur = sel.value;
    const sources = [...new Set(rowsRaw.map(r => safeStr(r.Source).trim()).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b));
    sel.innerHTML = `<option value="">Todos</option>` + sources.map(s => `<option value="${s}">${s}</option>`).join("");
    sel.value = sources.includes(cur) ? cur : "";
  }

  function applyLocalFilters(){
    const q = $("q").value.trim().toLowerCase();
    const src = $("selSource").value.trim().toLowerCase();
    const fromISO = $("from").value;
    const toISO = $("to").value;

    rowsFiltered = rowsRaw.filter(r=>{
      // (3) Overlap por fechas (incluye cualquier reserva que toque el rango)
      if(fromISO && toISO){
        if(!overlaps(r.DateArrival, r.DateDeparture, fromISO, toISO)) return false;
      }

      if(src && safeStr(r.Source).toLowerCase() !== src) return false;

      if(!q) return true;
      const hay = [
        r.Id, r.Source, r.Status, r.HouseName, r.GuestName, r.LineItem, r.Currency
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });

    renderKPIs();
    renderTable();
    renderChart();
  }

  function renderKPIs(){
    $("pillFiltered").textContent = `${rowsFiltered.length.toLocaleString("es-MX")} filas`;

    const uniq = new Set(rowsFiltered.map(r => safeStr(r.Id))).size;
    $("kpiBookings").textContent = uniq.toLocaleString("es-MX");

    const nights = rowsFiltered.reduce((a,r)=>a + safeNum(r.Nights), 0);
    $("kpiNights").textContent = nights.toLocaleString("es-MX");

    const gross = rowsFiltered.reduce((a,r)=>a + safeNum(r.GrossAmount), 0);
    $("kpiGross").textContent = moneyMXN(gross);
  }

  function renderTable(){
    const tb = $("tbody");
    tb.innerHTML = "";
    const frag = document.createDocumentFragment();

    for(const r of rowsFiltered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${safeStr(r.Id) || "—"}</td>
        <td>${safeStr(r.Source) || "—"}</td>
        <td>${safeStr(r.Status) || "—"}</td>
        <td class="mono">${safeStr(r.DateArrival) || "—"}</td>
        <td class="mono">${safeStr(r.DateDeparture) || "—"}</td>
        <td class="mono">${safeNum(r.Nights) || 0}</td>
        <td title="${safeStr(r.HouseName)}">${safeStr(r.HouseName) || "—"}</td>
        <td title="${safeStr(r.GuestName)}">${safeStr(r.GuestName) || "—"}</td>
        <td>${safeStr(r.LineItem) || "—"}</td>
        <td class="mono">${moneyMXN(r.GrossAmount)}</td>
        <td class="mono">${safeStr(r.Currency) || "—"}</td>
      `;
      frag.appendChild(tr);
    }
    tb.appendChild(frag);
  }

  function renderChart(){
    const m = new Map();
    for(const r of rowsFiltered){
      const k = safeStr(r.Source).trim() || "—";
      m.set(k, (m.get(k) || 0) + 1);
    }
    const labels = [...m.keys()].sort((a,b)=> (m.get(b)-m.get(a)));
    const data = labels.map(k => m.get(k));

    if(chSource) chSource.destroy();
    chSource = new Chart($("chSource"), {
      type: "bar",
      data: { labels, datasets: [{ label: "Line items por Source", data }] },
      options: {
        responsive:true,
        plugins:{ legend:{ display:true } },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  }

  // =========================
  // CSV
  // =========================
  function downloadCSV(){
    const url = `${API_BASE}/api/otc.csv?${qs()}`;
    window.location.href = url;
  }

  // =========================
  // Init
  // =========================
  function setDefaultDates(){
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();
    const first = new Date(Date.UTC(y, m, 1));
    const last = new Date(Date.UTC(y, m + 1, 0));

    const pad = (x)=>String(x).padStart(2,"0");
    const ymd = (d)=>`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;

    $("from").value = ymd(first);
    $("to").value = ymd(last);
  }

  (function init(){
    $("baseUrl").textContent = API_BASE || "same-origin";
    setDefaultDates();

    $("btnLoad").addEventListener("click", async ()=>{
      try{ await loadOTC(); }catch(e){ setStatus("err","Error"); alert(String(e.message || e)); }
    });
    $("btnCsv").addEventListener("click", downloadCSV);
    $("btnDebug").addEventListener("click", loadDebug);

    // Filtrado local inmediato (sin recargar) para q/source/fechas
    ["q","selSource","from","to"].forEach(id=>{
      $(id).addEventListener("input", applyLocalFilters);
      $(id).addEventListener("change", applyLocalFilters);
    });

    // Autoload
    $("btnLoad").click();
  })();
</script>
</body>
</html>
