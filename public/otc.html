<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkinnreservas · Dashboard OTC</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --panel:#0f1a30; --text:#e8eefc; --muted:#9fb0d0; --line:#1e2b4a;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --r:16px; --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font);
      background:linear-gradient(180deg,#070b15 0%, #0b1220 40%, #070b15 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(7,11,21,.75); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1280px; margin:0 auto; padding:16px 18px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, #4cc9f0 0%, #4361ee 55%, #3a0ca3 100%);
      box-shadow: 0 10px 20px rgba(67,97,238,.35);
    }
    h1{font-size:16px; margin:0; font-weight:800; letter-spacing:.2px}
    .sub{margin:2px 0 0; color:var(--muted); font-size:12px}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    button, select, input{
      background:var(--panel); color:var(--text);
      border:1px solid var(--line); border-radius:12px; padding:10px 12px;
      font-size:13px; outline:none;
    }
    select[multiple]{ padding:8px 10px; }
    button{cursor:pointer}
    button:hover{border-color:#2b3c63}
    button.primary{
      background:linear-gradient(180deg, rgba(76,201,240,.18), rgba(67,97,238,.10));
      border-color:rgba(76,201,240,.35);
    }
    button.ghost{background:transparent}
    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:rgba(11,18,32,.65); border:1px solid var(--line);
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:999px; background:#64748b}
    .dot.ok{background:#4ade80}
    .dot.err{background:#fb7185}
    .dot.busy{background:#fbbf24}

    .card{
      background:linear-gradient(180deg, rgba(15,26,48,.98), rgba(11,18,32,.98));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-top:14px;
    }
    .hd{
      padding:14px 14px 10px; border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .hd h2{margin:0; font-size:14px; letter-spacing:.2px}
    .hint{margin:3px 0 0; font-size:12px; color:var(--muted)}
    .bd{padding:14px}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
    .row > *{flex:1}
    .row .small{flex:.9}
    .row .xsmall{flex:.75}

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px;
      background:rgba(76,201,240,.10);
      border:1px solid rgba(76,201,240,.22);
      color:var(--text);
      font-size:12px;
      white-space:nowrap;
    }

    .kpis{
      display:grid; gap:10px;
      grid-template-columns: repeat(6, 1fr);
    }
    @media (max-width: 1100px){ .kpis{grid-template-columns:repeat(3,1fr)} }
    @media (max-width: 720px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr} }

    .kpi{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,31,58,.7), rgba(15,26,48,.55));
      border-radius:16px;
      padding:12px;
      min-height: 88px;
    }
    .kpi .lbl{font-size:12px; color:var(--muted)}
    .kpi .val{margin-top:6px; font-size:18px; font-weight:900; letter-spacing:.3px}
    .kpi .meta{margin-top:6px; font-size:12px; color:var(--muted)}
    .kpi .mini{margin-top:8px; height:90px; width:100%}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    .tableWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:rgba(18,31,58,.35);
    }
    table{width:100%; border-collapse:collapse; font-size:12.5px}
    thead{
      position:sticky; top:0;
      background:rgba(11,18,32,.95);
      z-index:5;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(30,43,74,.75);
      vertical-align:top;
      text-align:left;
      white-space:nowrap;
    }
    tbody tr:hover{background:rgba(76,201,240,.06)}
    .scrollY{max-height: 560px; overflow:auto;}
    .footer{padding:14px 18px; color:var(--muted); font-size:12px; border-top:1px solid var(--line);}

    /* ======= OCUPACIÓN: tabla sticky header + sticky first col ======= */
    .occScroll{
      max-height: 520px;
      overflow: auto;
    }
    #occTable{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size:12.5px;
    }
    #occTable th, #occTable td{
      padding:10px 10px;
      border-bottom:1px solid rgba(30,43,74,.75);
      white-space: nowrap;
    }
    #occTable thead th{
      position: sticky;
      top: 0;
      z-index: 7;
      background: rgba(11,18,32,.98);
      border-bottom: 1px solid rgba(30,43,74,.75);
    }
    #occTable .houseCol{
      position: sticky;
      left: 0;
      z-index: 6;
      background: rgba(11,18,32,.98);
      border-right: 1px solid rgba(30,43,74,.75);
      font-weight: 800;
    }
    #occTable thead th.houseCol{ z-index: 10; }

    .occCell{
      min-width: 210px;
      white-space: normal;
      line-height: 1.25;
    }
    .occTop{
      display:flex; justify-content:space-between; gap:10px;
      font-size:12px; color:var(--muted);
    }
    .occMain{
      margin-top:6px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:12.5px;
    }
    .bar{
      flex:1;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(76,201,240,.9), rgba(67,97,238,.9));
    }

    /* Ocupación: línea */
    #occLineWrap{ overflow:hidden; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Checkinnreservas · Dashboard OTC</h1>
          <div class="sub">Backend: Cloud Run · <span class="mono" id="baseUrl">same-origin</span></div>
        </div>
      </div>

      <div class="actions">
        <span id="apiStatus" class="status"><span class="dot busy"></span><span>Listo</span></span>
        <button id="btnLoad" class="primary">Cargar</button>
        <button id="btnCsv">Descargar CSV</button>
        <button id="btnDebug" class="ghost">Debug</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- Parámetros -->
  <section class="card">
    <div class="hd">
      <div>
        <h2>Parámetros</h2>
        <div class="hint">
          API: <span class="mono">/api/otc</span> y <span class="mono">/api/otc.csv</span> · Fechas incluyen overlap.
        </div>
      </div>
      <div class="hint" id="metaLine">—</div>
    </div>

    <div class="bd">
      <div class="row">
        <label style="flex:1">
          <div class="hint">Desde</div>
          <input id="from" type="date" />
        </label>
        <label style="flex:1">
          <div class="hint">Hasta</div>
          <input id="to" type="date" />
        </label>

        <label class="small">
          <div class="hint">Buscar</div>
          <input id="q" placeholder="Guest / House / Id / Source / LineItem..." />
        </label>

        <label class="xsmall">
          <div class="hint">Propiedad</div>
          <select id="selPropiedad" multiple size="4" title="Ctrl/Cmd para multiselección">
          </select>
        </label>

        <label class="xsmall">
          <div class="hint">Source</div>
          <select id="selSource">
            <option value="">Todos</option>
          </select>
        </label>

        <label class="xsmall">
          <div class="hint">Status</div>
          <select id="selStatus">
            <option value="">Todos</option>
          </select>
        </label>
      </div>

      <div class="hint" style="margin-top:10px">
        Tip: En <b>Propiedad</b> puedes seleccionar múltiples (Ctrl/Cmd). Si no seleccionas nada, se asume “todas”.
      </div>
    </div>
  </section>

  <!-- KPIs + mini charts por monto -->
  <section class="card">
    <div class="hd">
      <div>
        <h2>KPIs</h2>
        <div class="hint">Montos por LineItem + mini gráficas por <b>monto</b> (sum GrossAmount)</div>
      </div>
      <div class="hint"><span class="pill" id="pillFiltered">0 filas</span></div>
    </div>

    <div class="bd">
      <div class="kpis">
        <div class="kpi">
          <div class="lbl">Reservas únicas</div>
          <div class="val" id="kpiBookings">—</div>
          <div class="meta">IDs distintos</div>
        </div>

        <div class="kpi">
          <div class="lbl">Noches (sum)</div>
          <div class="val" id="kpiNights">—</div>
          <div class="meta">Suma Nights</div>
        </div>

        <div class="kpi">
          <div class="lbl">Gross (sum)</div>
          <div class="val" id="kpiGross">—</div>
          <div class="meta">Suma GrossAmount</div>
        </div>

        <div class="kpi">
          <div class="lbl">RoomRate (sum)</div>
          <div class="val" id="kpiRoomRate">—</div>
          <div class="meta">LineItem = RoomRate</div>
        </div>

        <div class="kpi">
          <div class="lbl">Fee (sum)</div>
          <div class="val" id="kpiFee">—</div>
          <div class="meta">LineItem = Fee</div>
        </div>

        <div class="kpi">
          <div class="lbl">Tax (sum)</div>
          <div class="val" id="kpiTax">—</div>
          <div class="meta">LineItem = Tax</div>
        </div>

        <!-- ✅ CAMBIO: Source ahora es BARRAS -->
        <div class="kpi" style="grid-column: span 3;">
          <div class="lbl">Monto por Source</div>
          <div class="meta">Barras (sum GrossAmount, top 12)</div>
          <div class="mini"><canvas id="chSourceBar"></canvas></div>
        </div>

        <div class="kpi" style="grid-column: span 3;">
          <div class="lbl">Monto por Status</div>
          <div class="meta">Barras (sum GrossAmount, top 12)</div>
          <div class="mini"><canvas id="chStatusBar"></canvas></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Ocupación -->
  <section class="card">
    <div class="hd">
      <div>
        <h2>Ocupación por alojamiento (por mes)</h2>
        <div class="hint">
          Se calcula con Arrival–Departure, deduplicando por <span class="mono">Id</span>.
          Muestra: noches ocupadas, % y barra. Incluye gráfica de líneas (%).
        </div>
      </div>
      <div class="hint" id="occMeta">—</div>
    </div>

    <div class="bd">
      <div class="row" style="margin-bottom:10px">
        <label class="small">
          <div class="hint">Vista</div>
          <select id="occView">
            <option value="table">Tabla</option>
            <option value="line">Gráfica de líneas (% ocupación)</option>
          </select>
        </label>

        <!-- ✅ NUEVO: filtro Propiedad (ocupación) -->
        <label style="flex:1.2">
          <div class="hint">Propiedad</div>
          <select id="occPropiedad" multiple size="4" title="Ctrl/Cmd para multiselección">
          </select>
        </label>

        <!-- ✅ CAMBIO: filtro de alojamientos (multiselección) -->
        <label style="flex:2">
          <div class="hint">Alojamientos (HouseName)</div>
          <select id="occHouses" multiple size="4" title="Ctrl/Cmd para multiselección"></select>
        </label>

        <div class="hint" style="flex:2; align-self:end">
          Tip: si no seleccionas alojamientos, se muestran todos (según filtros).
        </div>
      </div>

      <!-- Line chart -->
      <div id="occLineWrap" class="tableWrap" style="display:none;">
        <div style="height:420px; padding:10px;">
          <canvas id="occLineChart"></canvas>
        </div>
      </div>

      <!-- Table -->
      <div id="occTableWrap" class="tableWrap">
        <div class="occScroll">
          <table id="occTable">
            <thead id="occThead"></thead>
            <tbody id="occTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="hint" style="margin-top:10px">
        Nota: “% ocupación” = noches ocupadas / noches del mes (solo noches, no ingresos).
      </div>
    </div>
  </section>

  <!-- Tabla OTC -->
  <section class="card">
    <div class="hd">
      <div>
        <h2>Tabla OTC</h2>
        <div class="hint">Tabla + filtros locales + overlap por fechas</div>
      </div>
    </div>

    <div class="bd">
      <div class="tableWrap">
        <div class="scrollY">
          <table>
            <thead>
              <tr>
                <th>Id</th>
                <th>Propiedad</th>
                <th>Source</th>
                <th>Status</th>
                <th>Arrival</th>
                <th>Departure</th>
                <th>Nights</th>
                <th>HouseName</th>
                <th>GuestName</th>
                <th>LineItem</th>
                <th>GrossAmount</th>
                <th>Currency</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">
      Export CSV usa: <span class="mono">/api/otc.csv</span>
    </div>
  </section>

</main>

<script>
  // Si abres desde GitHub Pages, define aquí tu Cloud Run:
  // const API_BASE = "https://checkinnreservas-1044570371371.northamerica-south1.run.app";
  const API_BASE = "";

  let rowsRaw = [];
  let rowsFiltered = [];

  // Charts
  let chSourceBar = null;
  let chStatusBar = null;
  let chOccLines = null;

  // Ocupación series cache
  let occSeries = null; // { months:[...], houses:[...], propertyByHouse: Map, pctByHouse: Map(house -> [pct...]) }

  const $ = (id) => document.getElementById(id);

  function setStatus(kind, text){
    const el = $("apiStatus");
    const dot = el.querySelector(".dot");
    dot.classList.remove("ok","err","busy");
    dot.classList.add(kind);
    el.lastElementChild.textContent = text;
  }

  function moneyMXN(v){
    const n = Number(v);
    if(!Number.isFinite(n)) return "—";
    try{ return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(n); }
    catch{ return "$" + n.toFixed(2); }
  }

  function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }
  function safeNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }

  // ===== Propiedad derivada de HouseName =====
  // Ej: "José Cárdenas  #2 (..)" -> "José Cárdenas"
  //     "José Cárdenas #5 (...)" -> "José Cárdenas"
  function propertyFromHouse(house){
    let s = safeStr(house).trim();
    if(!s) return "—";

    // quita paréntesis al final (descripción)
    s = s.replace(/\s*\([^)]*\)\s*$/g, "").trim();

    // corta en '#'
    if (s.includes("#")) {
      s = s.split("#")[0].trim();
    }

    // también corta en ' - ' o ' – ' si acaso
    s = s.split(" - ")[0].split(" – ")[0].trim();

    // limpia doble espacios
    s = s.replace(/\s{2,}/g, " ").trim();

    return s || "—";
  }

  // Arrival/Departure vienen como "MM/DD/YYYY"
  function parseMMDDYYYY(s){
    const t = safeStr(s).trim();
    if(!t) return null;
    const m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(!m) return null;
    const mm = Number(m[1]), dd = Number(m[2]), yyyy = Number(m[3]);
    if(!mm || !dd || !yyyy) return null;
    return new Date(Date.UTC(yyyy, mm-1, dd, 0, 0, 0));
  }

  function parseISODateInput(s){
    const t = safeStr(s).trim();
    if(!t) return null;
    const m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const yyyy = Number(m[1]), mm = Number(m[2]), dd = Number(m[3]);
    return new Date(Date.UTC(yyyy, mm-1, dd, 0, 0, 0));
  }

  // overlap: [aStart, aEnd) toca [bStart, bEnd) si aStart < bEnd && bStart < aEnd
  function overlaps(arrivalMMDD, departureMMDD, fromISO, toISO){
    const aStart = parseMMDDYYYY(arrivalMMDD);
    const aEnd   = parseMMDDYYYY(departureMMDD);
    const bStart = parseISODateInput(fromISO);
    const bEnd   = parseISODateInput(toISO);
    if(!aStart || !aEnd || !bStart || !bEnd) return true;

    const bEndEx = new Date(bEnd.getTime());
    bEndEx.setUTCDate(bEndEx.getUTCDate() + 1); // end exclusivo (to inclusive)
    return (aStart < bEndEx) && (bStart < aEnd);
  }

  function qs(){
    const from = $("from").value;
    const to = $("to").value;
    return new URLSearchParams({ from, to }).toString();
  }

  function normalizeRow(r){
    const house = r.HouseName;
    const prop = propertyFromHouse(house);
    return {
      Id: r.Id,
      Property: prop,
      Source: r.Source,
      Status: r.Status,
      DateArrival: r.DateArrival,
      DateDeparture: r.DateDeparture,
      Nights: safeNum(r.Nights),
      HouseName: r.HouseName,
      GuestName: r.GuestName,
      LineItem: r.LineItem,
      GrossAmount: safeNum(r.GrossAmount),
      Currency: r.Currency,
      _raw: r
    };
  }

  async function loadOTC(){
    setStatus("busy", "Cargando...");
    $("metaLine").textContent = "—";

    const url = `${API_BASE}/api/otc?${qs()}`;
    const res = await fetch(url, { headers: { "Accept":"application/json" } });
    const data = await res.json();

    if(!res.ok || !data?.ok){
      setStatus("err", "Error");
      throw new Error(data?.error || `HTTP ${res.status}`);
    }

    rowsRaw = (data.rows || []).map(normalizeRow);
    setStatus("ok", `OK · ${rowsRaw.length} filas`);

    const metaBits = [
      `bookingsFetched=${data.bookingsFetched ?? "?"}`,
      `pagesUsed=${data.pagesUsed ?? "?"}`,
      `effectivePageSize=${data.effectivePageSize ?? "?"}`,
      `totalCount=${data.totalCount ?? "?"}`
    ];
    $("metaLine").textContent = metaBits.join(" · ");

    rebuildFilters();
    applyLocalFilters();
  }

  async function loadDebug(){
    setStatus("busy", "Debug...");
    const url = `${API_BASE}/api/debug/bookings`;
    const res = await fetch(url, { headers: { "Accept":"application/json" } });
    const data = await res.json();
    if(!res.ok || !data?.ok){
      setStatus("err","Debug error");
      alert(data?.error || `HTTP ${res.status}`);
      return;
    }
    setStatus("ok","Debug OK");
    alert(
      [
        "Debug paginación Lodgify",
        `effectivePageSize: ${data.effectivePageSize}`,
        `pagesUsed: ${data.pagesUsed}`,
        `totalCount: ${data.totalCount}`,
        `bookingsFetched: ${data.bookingsFetched}`,
        `arrivalMin: ${data.arrivalMin}`,
        `arrivalMax: ${data.arrivalMax}`,
      ].join("\n")
    );
  }

  function getSelectedValues(sel){
    if(!sel) return [];
    const vals = [];
    for(const opt of sel.options){
      if(opt.selected && opt.value !== "__ALL__" && opt.value !== "") vals.push(opt.value);
    }
    return vals;
  }

  function setMultiOptions(sel, items, keepSelectedValues = []){
    if(!sel) return;
    const selectedSet = new Set(keepSelectedValues);
    sel.innerHTML = items.map(v => {
      const esc = escapeHtml(v);
      const isSel = selectedSet.has(v) ? " selected" : "";
      return `<option value="${esc}"${isSel}>${esc}</option>`;
    }).join("");
  }

  function rebuildFilters(){
    // Propiedad (multi)
    const selP = $("selPropiedad");
    const prevP = getSelectedValues(selP);
    const props = [...new Set(rowsRaw.map(r => safeStr(r.Property).trim()).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b));
    setMultiOptions(selP, props, prevP);

    // Source (single)
    const selS = $("selSource");
    const curS = selS.value;
    const sources = [...new Set(rowsRaw.map(r => safeStr(r.Source).trim()).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b));
    selS.innerHTML = `<option value="">Todos</option>` + sources.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    selS.value = sources.includes(curS) ? curS : "";

    // Status (single)
    const selSt = $("selStatus");
    const curSt = selSt.value;
    const statuses = [...new Set(rowsRaw.map(r => safeStr(r.Status).trim()).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b));
    selSt.innerHTML = `<option value="">Todos</option>` + statuses.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    selSt.value = statuses.includes(curSt) ? curSt : "";
  }

  function applyLocalFilters(){
    const q = $("q").value.trim().toLowerCase();
    const src = $("selSource").value.trim().toLowerCase();
    const st = $("selStatus").value.trim().toLowerCase();
    const fromISO = $("from").value;
    const toISO = $("to").value;

    // global propiedad multiselect
    const propsSelected = getSelectedValues($("selPropiedad")).map(s=>s.toLowerCase());
    const hasPropFilter = propsSelected.length > 0;

    rowsFiltered = rowsRaw.filter(r=>{
      if(fromISO && toISO){
        if(!overlaps(r.DateArrival, r.DateDeparture, fromISO, toISO)) return false;
      }

      if(hasPropFilter){
        const rp = safeStr(r.Property).toLowerCase();
        if(!propsSelected.includes(rp)) return false;
      }

      if(src && safeStr(r.Source).toLowerCase() !== src) return false;
      if(st && safeStr(r.Status).toLowerCase() !== st) return false;

      if(!q) return true;
      const hay = [r.Id,r.Property,r.Source,r.Status,r.HouseName,r.GuestName,r.LineItem,r.Currency].join(" ").toLowerCase();
      return hay.includes(q);
    });

    renderKPIs();
    renderMiniChartsByAmount();
    renderOccupancyByMonth();
    renderTable();
  }

  function sumByLineItem(name){
    const key = String(name || "").toLowerCase();
    return rowsFiltered.reduce((acc, r)=>{
      if(safeStr(r.LineItem).toLowerCase() === key) return acc + safeNum(r.GrossAmount);
      return acc;
    }, 0);
  }

  function renderKPIs(){
    $("pillFiltered").textContent = `${rowsFiltered.length.toLocaleString("es-MX")} filas`;

    const uniq = new Set(rowsFiltered.map(r => safeStr(r.Id))).size;
    $("kpiBookings").textContent = uniq.toLocaleString("es-MX");

    const nights = rowsFiltered.reduce((a,r)=>a + safeNum(r.Nights), 0);
    $("kpiNights").textContent = nights.toLocaleString("es-MX");

    const gross = rowsFiltered.reduce((a,r)=>a + safeNum(r.GrossAmount), 0);
    $("kpiGross").textContent = moneyMXN(gross);

    $("kpiRoomRate").textContent = moneyMXN(sumByLineItem("RoomRate"));
    $("kpiFee").textContent      = moneyMXN(sumByLineItem("Fee"));
    $("kpiTax").textContent      = moneyMXN(sumByLineItem("Tax"));
  }

  function renderTable(){
    const tb = $("tbody");
    tb.innerHTML = "";
    const frag = document.createDocumentFragment();

    for(const r of rowsFiltered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(safeStr(r.Id) || "—")}</td>
        <td>${escapeHtml(safeStr(r.Property) || "—")}</td>
        <td>${escapeHtml(safeStr(r.Source) || "—")}</td>
        <td>${escapeHtml(safeStr(r.Status) || "—")}</td>
        <td class="mono">${escapeHtml(safeStr(r.DateArrival) || "—")}</td>
        <td class="mono">${escapeHtml(safeStr(r.DateDeparture) || "—")}</td>
        <td class="mono">${safeNum(r.Nights) || 0}</td>
        <td title="${escapeHtml(safeStr(r.HouseName))}">${escapeHtml(safeStr(r.HouseName) || "—")}</td>
        <td title="${escapeHtml(safeStr(r.GuestName))}">${escapeHtml(safeStr(r.GuestName) || "—")}</td>
        <td>${escapeHtml(safeStr(r.LineItem) || "—")}</td>
        <td class="mono">${moneyMXN(r.GrossAmount)}</td>
        <td class="mono">${escapeHtml(safeStr(r.Currency) || "—")}</td>
      `;
      frag.appendChild(tr);
    }
    tb.appendChild(frag);
  }

  // ===== mini charts by AMOUNT =====
  function buildSum(field){
    const m = new Map();
    for(const r of rowsFiltered){
      const k = safeStr(r[field]).trim() || "—";
      m.set(k, (m.get(k) || 0) + safeNum(r.GrossAmount));
    }
    const labels = [...m.keys()].sort((a,b)=> (m.get(b)-m.get(a)));
    const data = labels.map(k => m.get(k));
    return { labels, data };
  }

  function renderMiniChartsByAmount(){
    const src = buildSum("Source");
    const st  = buildSum("Status");

    const srcLabels = src.labels.slice(0,12);
    const srcData   = src.data.slice(0,12);

    const stLabels = st.labels.slice(0,12);
    const stData   = st.data.slice(0,12);

    if(chSourceBar) chSourceBar.destroy();
    if(chStatusBar) chStatusBar.destroy();

    // ✅ Source bar
    chSourceBar = new Chart($("chSourceBar"), {
      type: "bar",
      data: { labels: srcLabels, datasets: [{ label:"Monto", data: srcData }] },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{ enabled:true, callbacks:{ label: (ctx)=> ` ${moneyMXN(ctx.raw)}` } }
        },
        scales:{ y:{ beginAtZero:true } }
      }
    });

    // Status bar
    chStatusBar = new Chart($("chStatusBar"), {
      type: "bar",
      data: { labels: stLabels, datasets: [{ label:"Monto", data: stData }] },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          tooltip:{ enabled:true, callbacks:{ label: (ctx)=> ` ${moneyMXN(ctx.raw)}` } }
        },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  }

  // ===== Occupancy helpers =====
  function monthStartUTC(y, m0){ return new Date(Date.UTC(y, m0, 1, 0, 0, 0)); }
  function monthEndUTCExclusive(y, m0){ return new Date(Date.UTC(y, m0+1, 1, 0, 0, 0)); }

  function daysBetweenUTC(a, b){
    const ms = b.getTime() - a.getTime();
    return Math.max(0, Math.round(ms / 86400000));
  }

  function intersectNights(aStart, aEndEx, bStart, bEndEx){
    const s = (aStart > bStart) ? aStart : bStart;
    const e = (aEndEx < bEndEx) ? aEndEx : bEndEx;
    return daysBetweenUTC(s, e);
  }

  function monthsBetween(fromISO, toISO){
    const a = parseISODateInput(fromISO);
    const b = parseISODateInput(toISO);
    if(!a || !b) return [];

    const out = [];
    let y = a.getUTCFullYear();
    let m = a.getUTCMonth();
    const y2 = b.getUTCFullYear();
    const m2 = b.getUTCMonth();

    while (y < y2 || (y === y2 && m <= m2)){
      out.push({ y, m0: m, key: `${y}-${String(m+1).padStart(2,"0")}` });
      m++;
      if(m > 11){ m = 0; y++; }
    }
    return out;
  }

  function rebuildOccPropiedadOptionsFromFiltered(){
    const sel = $("occPropiedad");
    const prev = getSelectedValues(sel);

    // Propiedades disponibles según rowsFiltered (filtros globales)
    const props = [...new Set(rowsFiltered.map(r => safeStr(r.Property).trim()).filter(Boolean))]
      .sort((a,b)=>a.localeCompare(b));

    setMultiOptions(sel, props, prev);
  }

  function rebuildOccHousesOptions(housesAvailable){
    const sel = $("occHouses");
    const prev = getSelectedValues(sel);
    setMultiOptions(sel, housesAvailable, prev);
  }

  // ===== Occupancy render (table + line data) =====
  function renderOccupancyByMonth(){
    const fromISO = $("from").value;
    const toISO = $("to").value;

    const months = monthsBetween(fromISO, toISO);
    const thead = $("occThead");
    const tbody = $("occTbody");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    // rebuild options for occupancy filters based on current global filtering
    rebuildOccPropiedadOptionsFromFiltered();

    if(!months.length){
      $("occMeta").textContent = "Selecciona Desde/Hasta para calcular ocupación.";
      occSeries = null;
      renderOccLineChart();
      return;
    }

    // Deduplicar por Id para no contar múltiples line items
    const bookings = new Map(); // id -> {house, property, startUTC, endUTCEx}
    for(const r of rowsFiltered){
      const id = safeStr(r.Id);
      if(!id) continue;
      if(bookings.has(id)) continue;

      const start = parseMMDDYYYY(r.DateArrival);
      const endEx = parseMMDDYYYY(r.DateDeparture);
      const house = safeStr(r.HouseName).trim() || "—";
      const prop  = safeStr(r.Property).trim() || propertyFromHouse(house);

      if(!start || !endEx) continue;
      bookings.set(id, { house, property: prop, start, endEx });
    }

    // nights per house/month
    const map = new Map(); // house -> Map(monthKey -> nights)
    const propertyByHouse = new Map();
    const houseSet = new Set();
    const propSet = new Set();

    for(const b of bookings.values()){
      houseSet.add(b.house);
      propertyByHouse.set(b.house, b.property);
      propSet.add(b.property);

      for(const mo of months){
        const ms = monthStartUTC(mo.y, mo.m0);
        const me = monthEndUTCExclusive(mo.y, mo.m0);
        const n = intersectNights(b.start, b.endEx, ms, me);
        if(n <= 0) continue;

        if(!map.has(b.house)) map.set(b.house, new Map());
        const hm = map.get(b.house);
        hm.set(mo.key, (hm.get(mo.key) || 0) + n);
      }
    }

    // aplicar filtros locales (ocupación): Propiedad + Houses
    const occProps = getSelectedValues($("occPropiedad")).map(s=>s.toLowerCase());
    const occHasProp = occProps.length > 0;

    // houses disponibles tras filtro de propiedad (para poblar dropdown)
    let housesAvailable = [...houseSet].filter(h=>{
      if(!occHasProp) return true;
      const p = safeStr(propertyByHouse.get(h)).toLowerCase();
      return occProps.includes(p);
    }).sort((a,b)=>a.localeCompare(b));

    // refrescar dropdown Houses con base en propiedad elegida
    rebuildOccHousesOptions(housesAvailable);

    // ahora leer selección de houses (ya con opciones actualizadas)
    const occHouseSel = getSelectedValues($("occHouses"));
    const occHasHouse = occHouseSel.length > 0;
    const occHouseSet = new Set(occHouseSel);

    // houses finales a mostrar
    const housesToShow = housesAvailable.filter(h => !occHasHouse || occHouseSet.has(h));

    // Header
    const trh = document.createElement("tr");
    trh.innerHTML = `
      <th class="houseCol">HouseName</th>
      ${months.map(mo => `<th>${escapeHtml(mo.key)}</th>`).join("")}
    `;
    thead.appendChild(trh);

    // Body
    const frag = document.createDocumentFragment();

    for(const house of housesToShow){
      const tr = document.createElement("tr");
      const hm = map.get(house) || new Map();

      const rowCells = months.map(mo=>{
        const ms = monthStartUTC(mo.y, mo.m0);
        const me = monthEndUTCExclusive(mo.y, mo.m0);
        const totalNightsMonth = daysBetweenUTC(ms, me);

        const occ = hm.get(mo.key) || 0;
        const pct = totalNightsMonth > 0 ? (occ / totalNightsMonth) * 100 : 0;

        const pctTxt = `${pct.toFixed(0)}%`;
        const occTxt = `${occ}/${totalNightsMonth} noches`;

        return `
          <td class="occCell">
            <div class="occTop">
              <span class="mono">${escapeHtml(occTxt)}</span>
              <span class="mono">${escapeHtml(pctTxt)}</span>
            </div>
            <div class="occMain">
              <div class="bar" title="${escapeHtml(pctTxt)}">
                <div style="width:${Math.max(0, Math.min(100, pct)).toFixed(1)}%"></div>
              </div>
            </div>
          </td>
        `;
      }).join("");

      tr.innerHTML = `<td class="houseCol">${escapeHtml(house)}</td>${rowCells}`;
      frag.appendChild(tr);
    }

    tbody.appendChild(frag);

    $("occMeta").textContent =
      `Reservas únicas usadas: ${bookings.size.toLocaleString("es-MX")} · Alojamientos mostrados: ${housesToShow.length.toLocaleString("es-MX")} · Meses: ${months.length}`;

    // Build series for line chart using housesToShow
    buildOccupancySeriesForChart(months, housesToShow, map, propertyByHouse);
    renderOccLineChart();
    syncOccView();
  }

  function buildOccupancySeriesForChart(months, houses, mapHouseMonth, propertyByHouse){
    const pctByHouse = new Map();

    for(const house of houses){
      const arr = [];
      const hm = mapHouseMonth.get(house) || new Map();
      for(const mo of months){
        const ms = monthStartUTC(mo.y, mo.m0);
        const me = monthEndUTCExclusive(mo.y, mo.m0);
        const totalNightsMonth = daysBetweenUTC(ms, me);

        const occ = hm.get(mo.key) || 0;
        const pct = totalNightsMonth > 0 ? (occ / totalNightsMonth) * 100 : 0;
        arr.push(+pct.toFixed(2));
      }
      pctByHouse.set(house, arr);
    }

    occSeries = {
      months: months.map(m=>m.key),
      houses: [...houses],
      propertyByHouse: new Map(propertyByHouse || []),
      pctByHouse
    };
  }

  function renderOccLineChart(){
    const canvas = $("occLineChart");
    if(!canvas){
      if(chOccLines){ chOccLines.destroy(); chOccLines = null; }
      return;
    }
    if(!occSeries){
      if(chOccLines){ chOccLines.destroy(); chOccLines = null; }
      return;
    }

    const labels = occSeries.months;

    // datasets: una línea por house (ya filtradas por selección)
    const datasets = occSeries.houses.map(h=>{
      const data = occSeries.pctByHouse.get(h) || labels.map(()=>0);
      return {
        label: h,
        data,
        tension: 0.25,
        pointRadius: 0,
        borderWidth: 1,
      };
    });

    if(chOccLines) chOccLines.destroy();
    chOccLines = new Chart(canvas, {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "nearest", intersect: false },
        plugins: {
          legend: {
            display: true,
            position: "bottom",
            labels: { boxWidth: 10 }
            // Chart.js permite click para ocultar/mostrar líneas
          },
          tooltip: {
            callbacks: { label: (ctx)=> ` ${ctx.dataset.label}: ${ctx.raw}%` }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { callback: (v)=> `${v}%` }
          }
        }
      }
    });
  }

  function syncOccView(){
    const view = $("occView")?.value || "table";
    const lineWrap = $("occLineWrap");
    const tableWrap = $("occTableWrap");
    if(!lineWrap || !tableWrap) return;

    if(view === "line"){
      lineWrap.style.display = "";
      tableWrap.style.display = "none";
    }else{
      lineWrap.style.display = "none";
      tableWrap.style.display = "";
    }
  }

  function downloadCSV(){
    const url = `${API_BASE}/api/otc.csv?${qs()}`;
    window.location.href = url;
  }

  function setDefaultDates(){
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();
    const first = new Date(Date.UTC(y, m, 1));
    const last = new Date(Date.UTC(y, m + 1, 0));

    const pad = (x)=>String(x).padStart(2,"0");
    const ymd = (d)=>`${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`;

    $("from").value = ymd(first);
    $("to").value = ymd(last);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  (function init(){
    $("baseUrl").textContent = API_BASE || "same-origin";
    setDefaultDates();

    $("btnLoad").addEventListener("click", async ()=>{
      try{ await loadOTC(); }
      catch(e){ setStatus("err","Error"); alert(String(e.message || e)); }
    });
    $("btnCsv").addEventListener("click", downloadCSV);
    $("btnDebug").addEventListener("click", loadDebug);

    // filtros globales
    ["q","selSource","selStatus","from","to","selPropiedad"].forEach(id=>{
      $(id).addEventListener("input", applyLocalFilters);
      $(id).addEventListener("change", applyLocalFilters);
    });

    // ocupación: vista + filtros locales
    $("occView").addEventListener("change", syncOccView);
    $("occPropiedad").addEventListener("change", renderOccupancyByMonth);
    $("occHouses").addEventListener("change", renderOccupancyByMonth);

    // autoload
    $("btnLoad").click();
  })();
</script>
</body>
</html>
