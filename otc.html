<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OTC Report (Lodgify)</title>
  <style>
    :root{--bd:#e6e6e6;--bg:#fff;--mut:#666;--card:#fafafa}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:18px; background:var(--bg)}
    h1{margin:0 0 10px}
    .wrap{max-width:1400px; margin:0 auto}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:end; margin:14px 0}
    label{display:flex; flex-direction:column; font-size:12px; color:var(--mut); gap:6px}
    input,select,button{font:inherit; padding:10px 12px; border-radius:12px; border:1px solid var(--bd); background:#fff}
    button{cursor:pointer; background:#0b5fff; border-color:#0b5fff; color:#fff; font-weight:600}
    button.secondary{background:#fff; color:#0b5fff}
    .kpis{display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 16px}
    .kpi{border:1px solid var(--bd); border-radius:14px; padding:10px 12px; background:var(--card)}
    .kpi b{font-size:16px}
    .tableWrap{border:1px solid var(--bd); border-radius:14px; overflow:auto; height:70vh}
    table{border-collapse:collapse; width:max(1400px,100%)}
    th,td{border-bottom:1px solid var(--bd); padding:8px 10px; font-size:12px; white-space:nowrap}
    th{position:sticky; top:0; background:#f7f7f7; z-index:1; text-align:left}
    tr:hover td{background:#fffdf3}
    .muted{color:var(--mut)}
    .err{color:#b00020; font-weight:600}
  </style>
</head>
<body>
<div class="wrap">
  <h1>OTC Report (Lodgify) → Tabla estilo Excel</h1>
  <div class="controls">
    <label>From
      <input id="from" type="date" />
    </label>
    <label>To
      <input id="to" type="date" />
    </label>
    <label>Rows por página (API)
      <select id="limit">
        <option>50</option>
        <option>100</option>
        <option>200</option>
      </select>
    </label>
    <button id="btnRun">Consultar</button>
    <button class="secondary" id="btnCSV" title="Descargar CSV igual a columnas OTC">Descargar CSV</button>
    <span id="status" class="muted"></span>
  </div>

  <div class="kpis">
    <div class="kpi"><div class="muted">Bookings (raw)</div><b id="kpiBookings">—</b></div>
    <div class="kpi"><div class="muted">Rows OTC</div><b id="kpiRows">—</b></div>
  </div>

  <div id="error" class="err"></div>

  <div class="tableWrap">
    <table id="tbl">
      <thead><tr id="thead"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
const COLS = [
  "Id","Source","SourceText","ChannelBooking","Status","DateCancelled",
  "DateArrival","DateDeparture","Nights","HouseName","HouseId",
  "RoomTypeNames","RoomTypeIds","GuestName","GuestEmail",
  "NumberOfGuests","Adults","Children","Infants","Pets","Currency",
  "LineItem","LineItemDescription","GrossAmount","NetAmount","VatAmount"
];

function setDefaultDates(){
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");
  // default: current month
  const first = `${yyyy}-${mm}-01`;
  const last = new Date(yyyy, now.getMonth()+1, 0);
  const lastISO = `${yyyy}-${mm}-${String(last.getDate()).padStart(2,"0")}`;
  document.querySelector("#from").value = first;
  document.querySelector("#to").value = lastISO;
}

function renderHeader(){
  const tr = document.querySelector("#thead");
  tr.innerHTML = "";
  for(const c of COLS){
    const th = document.createElement("th");
    th.textContent = c;
    tr.appendChild(th);
  }
}

function renderRows(rows){
  const tb = document.querySelector("#tbody");
  tb.innerHTML = "";
  const frag = document.createDocumentFragment();
  for(const r of rows){
    const tr = document.createElement("tr");
    for(const c of COLS){
      const td = document.createElement("td");
      const v = (r[c] ?? "");
      td.textContent = v;
      tr.appendChild(td);
    }
    frag.appendChild(tr);
  }
  tb.appendChild(frag);
}

async function run(){
  const from = document.querySelector("#from").value;
  const to = document.querySelector("#to").value;
  const limit = document.querySelector("#limit").value;
  const status = document.querySelector("#status");
  const err = document.querySelector("#error");
  err.textContent = "";
  status.textContent = "Consultando...";
  try{
    const url = `/api/otc?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&limit=${encodeURIComponent(limit)}`;
    const res = await fetch(url);
    const data = await res.json();
    if(!res.ok || !data.ok){
      throw new Error(data.error || `HTTP ${res.status}`);
    }
    document.querySelector("#kpiBookings").textContent = data.bookingsCount ?? "—";
    document.querySelector("#kpiRows").textContent = data.rowsCount ?? (data.rows?.length ?? "—");
    renderRows(data.rows || []);
    status.textContent = `OK · ${data.rowsCount} rows`;
  }catch(e){
    err.textContent = `Error: ${e.message || e}`;
    status.textContent = "";
  }
}

function downloadCSV(){
  const from = document.querySelector("#from").value;
  const to = document.querySelector("#to").value;
  const limit = document.querySelector("#limit").value;
  const url = `/api/otc.csv?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&limit=${encodeURIComponent(limit)}`;
  window.location.href = url;
}

document.querySelector("#btnRun").addEventListener("click", run);
document.querySelector("#btnCSV").addEventListener("click", downloadCSV);

renderHeader();
setDefaultDates();
</script>
</body>
</html>
